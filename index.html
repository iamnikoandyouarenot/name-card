<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>åç‰‡ç®¡ç†ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #06d6a0;
            --primary-dark: #00b890;
            --accent: #3b82f6;
            --bg-dark: #0f172a;
            --bg-card: rgba(255,255,255,0.06);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255,255,255,0.1);
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(6, 214, 160, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);
        }

        .logo-text h1 { font-size: 18px; font-weight: 700; }
        .logo-text p { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 180px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 38px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box input:focus { border-color: var(--primary); }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .categories {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.08);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: transparent;
            font-weight: 600;
        }

        .main {
            padding: 16px;
            position: relative;
            z-index: 1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-value.primary { color: var(--primary); }
        .stat-value.accent { color: var(--accent); }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 14px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            border-color: rgba(6, 214, 160, 0.3);
        }

        .card-category {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-avatar {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .card-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .card-name-en { font-size: 12px; color: var(--text-muted); }
        .card-title { font-size: 12px; color: var(--text-secondary); }
        .card-company { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; }
        .card-contacts { display: flex; flex-direction: column; gap: 6px; }
        .card-contact { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }

        .card-line {
            background: rgba(6, 214, 160, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(6, 214, 160, 0.2);
            color: var(--primary);
            font-weight: 500;
        }

        .card-images {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .card-image-thumb {
            flex: 1;
            height: 50px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border);
        }

        /* åˆ†é¡é¡è‰² */
        .cat-å®¢æˆ¶ { background: #fef3c7; color: #92400e; }
        .cat-ä¾›æ‡‰å•† { background: #dbeafe; color: #1e40af; }
        .cat-åˆä½œå¤¥ä¼´ { background: #dcfce7; color: #166534; }
        .cat-åŒäº‹ { background: #fae8ff; color: #86198f; }
        .cat-æœ‹å‹ { background: #ffedd5; color: #9a3412; }
        .cat-å…¶ä»– { background: #f1f5f9; color: #334155; }

        .avatar-å®¢æˆ¶ { background: linear-gradient(135deg, #f59e0b, #fef3c7); color: #92400e; }
        .avatar-ä¾›æ‡‰å•† { background: linear-gradient(135deg, #3b82f6, #dbeafe); color: #1e40af; }
        .avatar-åˆä½œå¤¥ä¼´ { background: linear-gradient(135deg, #22c55e, #dcfce7); color: #166534; }
        .avatar-åŒäº‹ { background: linear-gradient(135deg, #d946ef, #fae8ff); color: #86198f; }
        .avatar-æœ‹å‹ { background: linear-gradient(135deg, #f97316, #ffedd5); color: #9a3412; }
        .avatar-å…¶ä»– { background: linear-gradient(135deg, #64748b, #f1f5f9); color: #334155; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 200;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            overflow-y: auto;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 480px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h2 { font-size: 18px; font-weight: 700; }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
        }

        .form-group { margin-bottom: 12px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }

        .form-input:focus { border-color: var(--primary); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input.highlight { background: rgba(6, 214, 160, 0.1); border-color: rgba(6, 214, 160, 0.3); }
        textarea.form-input { resize: vertical; min-height: 60px; }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .form-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 12px;
        }

        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .image-section {
            margin-bottom: 14px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            border: 1px dashed var(--border);
        }

        .image-section-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .image-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .image-box {
            flex: 1;
            aspect-ratio: 16/10;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .image-box.has-image {
            border-style: solid;
            border-color: var(--primary);
        }

        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-box-label {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        .image-box-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .image-btns {
            display: flex;
            gap: 8px;
        }

        .image-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .image-btn.camera { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; }
        .image-btn.gallery { background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--border); }
        .image-btn.recognize { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .image-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* å¤§é ­ç…§ */
        .avatar-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
        }

        .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-size: cover;
            background-position: center;
            border: 2px dashed var(--border);
            flex-shrink: 0;
            cursor: pointer;
        }

        .avatar-preview.has-image { border-style: solid; border-color: var(--primary); }
        .avatar-info { flex: 1; }
        .avatar-info h4 { font-size: 13px; margin-bottom: 3px; }
        .avatar-info p { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }

        .avatar-btns {
            display: flex;
            gap: 6px;
        }

        .avatar-btn {
            padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }

        /* OCR çµæœ */
        .ocr-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(6, 214, 160, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(6, 214, 160, 0.2);
            font-size: 11px;
            display: none;
        }

        .ocr-result.active { display: block; }
        .ocr-result h4 { color: var(--primary); margin-bottom: 6px; font-size: 12px; }
        .ocr-text { color: var(--text-secondary); line-height: 1.4; white-space: pre-wrap; max-height: 100px; overflow-y: auto; font-size: 11px; }

        /* è©³ç´°é  */
        .detail-header { display: flex; gap: 12px; margin-bottom: 14px; }

        .detail-avatar {
            width: 65px;
            height: 65px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .detail-info h2 { font-size: 22px; margin-bottom: 2px; }
        .detail-info .name-en { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
        .detail-info p { color: var(--text-secondary); font-size: 13px; }

        .detail-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 5px;
        }

        .detail-images {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }

        .detail-image {
            flex: 1;
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .detail-image img {
            width: 100%;
            display: block;
        }

        .detail-image-label {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            padding: 4px;
            background: rgba(0,0,0,0.3);
        }

        .detail-section {
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            padding: 7px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-row-icon { font-size: 14px; margin-right: 8px; }
        .detail-row-label { width: 55px; font-size: 11px; color: var(--text-muted); }
        .detail-row-value { flex: 1; font-size: 13px; word-break: break-all; }
        .detail-row-value a { color: var(--text-primary); text-decoration: none; }
        .detail-row-value a:hover { color: var(--primary); }
        .detail-row-value.line { color: var(--primary); font-weight: 500; }

        .detail-notes { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
        .detail-notes h4 { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
        .detail-notes p { font-size: 13px; line-height: 1.5; }

        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 45px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state h3 { font-size: 15px; margin-bottom: 6px; color: var(--text-secondary); }

        .notification {
            position: fixed;
            top: calc(10px + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 300;
            transition: transform 0.3s;
            font-size: 13px;
            max-width: 90%;
            text-align: center;
        }

        .notification.active { transform: translateX(-50%) translateY(0); }
        .notification.error { background: var(--danger); }
        .notification.success { background: var(--success); }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .sync-status { font-size: 10px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); }
        .sync-dot.online { background: var(--success); }
        .sync-dot.syncing { background: var(--accent); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* éš±è—çš„ input */
        .hidden-input { display: none; }

        /* è¼‰å…¥é®ç½© */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 400;
        }

        .loading-overlay.active { display: flex; }
        .loading-overlay .loading { width: 40px; height: 40px; border-width: 3px; }
        .loading-overlay p { color: var(--text-secondary); font-size: 14px; }

        @media (max-width: 480px) {
            .header-top { flex-wrap: wrap; }
            .form-row { grid-template-columns: 1fr; }
            .cards-grid { grid-template-columns: 1fr; }
            .avatar-section { flex-direction: column; text-align: center; }
            .avatar-btns { justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div id="loadingOverlay" class="loading-overlay">
        <span class="loading"></span>
        <p id="loadingText">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- éš±è—çš„ file inputs -->
    <input type="file" id="cardFrontCameraInput" class="hidden-input" accept="image/*" capture="environment">
    <input type="file" id="cardFrontGalleryInput" class="hidden-input" accept="image/*">
    <input type="file" id="cardBackCameraInput" class="hidden-input" accept="image/*" capture="environment">
    <input type="file" id="cardBackGalleryInput" class="hidden-input" accept="image/*">
    <input type="file" id="avatarCameraInput" class="hidden-input" accept="image/*" capture="user">
    <input type="file" id="avatarGalleryInput" class="hidden-input" accept="image/*">

    <header class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-icon">ğŸ“‡</div>
                <div class="logo-text">
                    <h1>åç‰‡ç®¡ç†ä¸­å¿ƒ</h1>
                    <p>â˜ï¸ é›²ç«¯åŒæ­¥ç‰ˆ</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="sync-status">
                    <span class="sync-dot" id="syncDot"></span>
                    <span id="syncText">é›¢ç·š</span>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="reloadApp()" title="é‡æ–°æ•´ç†">ğŸ”„</button>
                <button class="btn btn-secondary btn-icon" onclick="syncFromCloud()" title="é›²ç«¯åŒæ­¥">â˜ï¸</button>
                <button class="btn btn-primary" onclick="openAddModal()">â• æ–°å¢</button>
            </div>
        </div>
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€å…¬å¸ã€LINE..." oninput="filterCards()">
            </div>
            <div class="categories" id="categories"></div>
        </div>
    </header>

    <main class="main">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š ç¸½åç‰‡</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¬ æœ‰LINE</div>
                <div class="stat-value primary" id="lineCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ” çµæœ</div>
                <div class="stat-value accent" id="filterCount">0</div>
            </div>
        </div>
        <div class="cards-grid" id="cardsGrid"></div>
    </main>

    <!-- æ–°å¢ Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">â• æ–°å¢åç‰‡</h2>
                <button class="modal-close" onclick="closeAddModal()">âœ•</button>
            </div>

            <!-- åç‰‡ç…§ç‰‡å€ -->
            <div class="image-section">
                <div class="image-section-title">ğŸ“¸ åç‰‡ç…§ç‰‡</div>
                <div class="image-row">
                    <div class="image-box" id="cardFrontBox">
                        <span class="image-box-icon">ğŸ“„</span>
                        <span class="image-box-label">æ­£é¢</span>
                    </div>
                    <div class="image-box" id="cardBackBox">
                        <span class="image-box-icon">ğŸ“„</span>
                        <span class="image-box-label">èƒŒé¢</span>
                    </div>
                </div>
                <div class="image-btns">
                    <button type="button" class="image-btn camera" onclick="captureCard('front')">ğŸ“· æ‹æ­£é¢</button>
                    <button type="button" class="image-btn gallery" onclick="selectCard('front')">ğŸ–¼ï¸ é¸æ­£é¢</button>
                    <button type="button" class="image-btn recognize" id="recognizeBtn" onclick="recognizeCard()" disabled>ğŸ” è¾¨è­˜</button>
                </div>
                <div class="image-btns" style="margin-top:6px;">
                    <button type="button" class="image-btn camera" onclick="captureCard('back')">ğŸ“· æ‹èƒŒé¢</button>
                    <button type="button" class="image-btn gallery" onclick="selectCard('back')">ğŸ–¼ï¸ é¸èƒŒé¢</button>
                </div>
                <div class="ocr-result" id="ocrResult">
                    <h4>ğŸ“ è¾¨è­˜çµæœ</h4>
                    <div class="ocr-text" id="ocrText"></div>
                </div>
            </div>

            <!-- å¤§é ­ç…§å€ -->
            <div class="avatar-section">
                <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                <div class="avatar-info">
                    <h4>ğŸ“¸ å¤§é ­ç…§</h4>
                    <p>ä¸Šå‚³è¯çµ¡äººç…§ç‰‡</p>
                    <div class="avatar-btns">
                        <button type="button" class="avatar-btn" onclick="captureAvatar()">ğŸ“· æ‹ç…§</button>
                        <button type="button" class="avatar-btn" onclick="selectAvatar()">ğŸ–¼ï¸ é¸æ“‡</button>
                    </div>
                </div>
            </div>

            <!-- è¡¨å–® -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ å§“åï¼ˆä¸­æ–‡ï¼‰*</label>
                    <input type="text" class="form-input" id="cardName" placeholder="ç‹å¤§æ˜">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ”¤ è‹±æ–‡å</label>
                    <input type="text" class="form-input" id="cardNameEn" placeholder="David Wang">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ¢ å…¬å¸</label>
                    <input type="text" class="form-input" id="cardCompany" placeholder="å°ç£ç§‘æŠ€å…¬å¸">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ åˆ†é¡</label>
                    <select class="form-input" id="cardCategory">
                        <option value="å®¢æˆ¶">å®¢æˆ¶</option>
                        <option value="ä¾›æ‡‰å•†">ä¾›æ‡‰å•†</option>
                        <option value="åˆä½œå¤¥ä¼´">åˆä½œå¤¥ä¼´</option>
                        <option value="åŒäº‹">åŒäº‹</option>
                        <option value="æœ‹å‹">æœ‹å‹</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ’¼ è·ç¨±</label>
                <input type="text" class="form-input" id="cardTitle" placeholder="æ¥­å‹™ç¶“ç†">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ“± é›»è©±</label>
                    <input type="tel" class="form-input" id="cardPhone" placeholder="0912-345-678">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’¬ LINE ID</label>
                    <input type="text" class="form-input highlight" id="cardLine" placeholder="line_id">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">âœ‰ï¸ Email</label>
                <input type="email" class="form-input" id="cardEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ“ åœ°å€</label>
                <input type="text" class="form-input" id="cardAddress" placeholder="å°åŒ—å¸‚...">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸŒ ç¶²ç«™</label>
                <input type="text" class="form-input" id="cardWebsite" placeholder="www.example.com">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ“ å‚™è¨»</label>
                <textarea class="form-input" id="cardNotes" placeholder="å‚™è¨»..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveCard()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- è©³ç´° Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ“‡ åç‰‡è©³æƒ…</h2>
                <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        // ===== API è¨­å®š =====
        const API_URL = 'https://script.google.com/macros/s/AKfycbxsDT1GpMUWkLTh8HQIB6QMVOM6aMXS2IvBy1hpWy_y5mgyOakb__p0XQm1cn2q6N0LVQ/exec';

        const CATEGORIES = ['å…¨éƒ¨', 'å®¢æˆ¶', 'ä¾›æ‡‰å•†', 'åˆä½œå¤¥ä¼´', 'åŒäº‹', 'æœ‹å‹', 'å…¶ä»–'];

        // ===== å…¨åŸŸè®Šæ•¸ =====
        let cards = [];
        let currentCategory = 'å…¨éƒ¨';
        let cardFrontImage = null;  // base64
        let cardBackImage = null;   // base64
        let avatarImage = null;     // base64
        let cardFrontUrl = '';      // Drive URL
        let cardBackUrl = '';       // Drive URL
        let avatarUrl = '';         // Drive URL
        let editingId = null;

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App v5 åˆå§‹åŒ–...');
            initCategories();
            initFileInputs();
            loadFromLocal();
            renderCards();
            syncFromCloud();
        });

        // ===== é¡¯ç¤º/éš±è—è¼‰å…¥ä¸­ =====
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'è¼‰å…¥ä¸­...';
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ===== Reload =====
        function reloadApp() {
            showNotification('ğŸ”„ é‡æ–°æ•´ç†ä¸­...');
            setTimeout(function() {
                location.reload();
            }, 300);
        }

        // ===== åˆå§‹åŒ–åˆ†é¡ =====
        function initCategories() {
            var container = document.getElementById('categories');
            container.innerHTML = CATEGORIES.map(function(cat) {
                return '<button class="category-btn ' + (cat === 'å…¨éƒ¨' ? 'active' : '') + '" data-cat="' + cat + '" onclick="selectCategory(this)">' + cat + '</button>';
            }).join('');
        }

        // ===== åˆå§‹åŒ–æª”æ¡ˆè¼¸å…¥ =====
        function initFileInputs() {
            document.getElementById('cardFrontCameraInput').addEventListener('change', function(e) { handleCardImage(e, 'front'); });
            document.getElementById('cardFrontGalleryInput').addEventListener('change', function(e) { handleCardImage(e, 'front'); });
            document.getElementById('cardBackCameraInput').addEventListener('change', function(e) { handleCardImage(e, 'back'); });
            document.getElementById('cardBackGalleryInput').addEventListener('change', function(e) { handleCardImage(e, 'back'); });
            document.getElementById('avatarCameraInput').addEventListener('change', handleAvatarImage);
            document.getElementById('avatarGalleryInput').addEventListener('change', handleAvatarImage);
        }

        // ===== å£“ç¸®åœ–ç‰‡ =====
        function compressImage(file, maxWidth, quality, callback) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var ratio = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    var dataUrl = canvas.toDataURL('image/jpeg', quality);
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleCardImage(e, side) {
            var file = e.target.files[0];
            if (!file) return;

            compressImage(file, 1200, 0.8, function(dataUrl) {
                var box = document.getElementById(side === 'front' ? 'cardFrontBox' : 'cardBackBox');
                
                if (side === 'front') {
                    cardFrontImage = dataUrl;
                    document.getElementById('recognizeBtn').disabled = false;
                } else {
                    cardBackImage = dataUrl;
                }

                box.innerHTML = '<img src="' + dataUrl + '" alt="åç‰‡">';
                box.classList.add('has-image');
            });
        }

        function handleAvatarImage(e) {
            var file = e.target.files[0];
            if (!file) return;

            compressImage(file, 400, 0.8, function(dataUrl) {
                avatarImage = dataUrl;
                var preview = document.getElementById('avatarPreview');
                preview.style.backgroundImage = 'url("' + dataUrl + '")';
                preview.classList.add('has-image');
                preview.textContent = '';
            });
        }

        function captureCard(side) {
            document.getElementById(side === 'front' ? 'cardFrontCameraInput' : 'cardBackCameraInput').click();
        }

        function selectCard(side) {
            document.getElementById(side === 'front' ? 'cardFrontGalleryInput' : 'cardBackGalleryInput').click();
        }

        function captureAvatar() {
            document.getElementById('avatarCameraInput').click();
        }

        function selectAvatar() {
            document.getElementById('avatarGalleryInput').click();
        }

        // ===== é€šçŸ¥ =====
        function showNotification(msg, type) {
            var el = document.getElementById('notification');
            el.textContent = msg;
            el.className = 'notification active';
            if (type === 'error') el.classList.add('error');
            if (type === 'success') el.classList.add('success');
            setTimeout(function() { el.className = 'notification'; }, 3000);
        }

        // ===== æœ¬åœ°å„²å­˜ï¼ˆå‚™ä»½ç”¨ï¼‰=====
        function loadFromLocal() {
            try {
                var saved = localStorage.getItem('businessCards_v5');
                if (saved) {
                    cards = JSON.parse(saved);
                    console.log('æœ¬åœ°è³‡æ–™:', cards.length, 'ç­†');
                }
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
                cards = [];
            }
        }

        function saveToLocal() {
            try {
                // å„²å­˜æ™‚ä¸åŒ…å« base64 åœ–ç‰‡ï¼ˆåªå­˜ URLï¼‰
                var dataToSave = cards.map(function(c) {
                    return {
                        id: c.id,
                        name: c.name,
                        nameEn: c.nameEn,
                        company: c.company,
                        title: c.title,
                        phone: c.phone,
                        email: c.email,
                        lineId: c.lineId,
                        category: c.category,
                        address: c.address,
                        website: c.website,
                        notes: c.notes,
                        cardFrontUrl: c.cardFrontUrl || '',
                        cardBackUrl: c.cardBackUrl || '',
                        avatarUrl: c.avatarUrl || ''
                    };
                });
                localStorage.setItem('businessCards_v5', JSON.stringify(dataToSave));
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }

        // ===== é›²ç«¯ API å‘¼å« =====
        async function apiCall(action, data) {
            var body = Object.assign({ action: action }, data);
            
            var response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(body)
            });
            
            return await response.json();
        }

        async function apiGet() {
            var response = await fetch(API_URL);
            return await response.json();
        }

        // ===== é›²ç«¯åŒæ­¥ =====
        async function syncFromCloud() {
            var dot = document.getElementById('syncDot');
            var text = document.getElementById('syncText');
            dot.className = 'sync-dot syncing';
            text.textContent = 'åŒæ­¥ä¸­...';

            try {
                var result = await apiGet();
                console.log('é›²ç«¯è³‡æ–™:', result);

                if (result.success && result.data) {
                    cards = result.data.map(function(row) {
                        // ç¢ºä¿æ‰€æœ‰å€¼éƒ½æ˜¯å­—ä¸²
                        var str = function(val) { return val === null || val === undefined ? '' : String(val); };
                        return {
                            id: str(row['ID']) || String(Date.now()),
                            name: str(row['å§“å']),
                            nameEn: str(row['è‹±æ–‡å']),
                            company: str(row['å…¬å¸']),
                            title: str(row['è·ç¨±']),
                            phone: str(row['é›»è©±']),
                            email: str(row['Email']),
                            lineId: str(row['LINE_ID']),
                            category: str(row['åˆ†é¡']) || 'å…¶ä»–',
                            address: str(row['åœ°å€']),
                            website: str(row['ç¶²ç«™']),
                            notes: str(row['å‚™è¨»']),
                            cardFrontUrl: str(row['åç‰‡æ­£é¢']),
                            cardBackUrl: str(row['åç‰‡èƒŒé¢']),
                            avatarUrl: str(row['å¤§é ­ç…§'])
                        };
                    });

                    saveToLocal();
                    renderCards();
                    showNotification('âœ… åŒæ­¥æˆåŠŸï¼' + cards.length + ' ç­†', 'success');
                    dot.className = 'sync-dot online';
                    text.textContent = 'å·²é€£ç·š';
                } else {
                    throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                }
            } catch (err) {
                console.error('åŒæ­¥éŒ¯èª¤:', err);
                showNotification('åŒæ­¥å¤±æ•—: ' + err.message, 'error');
                dot.className = 'sync-dot';
                text.textContent = 'é›¢ç·š';
            }
        }

        // ===== ä¸Šå‚³åœ–ç‰‡åˆ° Google Drive =====
        async function uploadImageToDrive(base64Data, fileName) {
            if (!base64Data) return '';
            
            try {
                var base64Content = base64Data.split(',')[1];
                var mimeType = base64Data.match(/data:(.*?);/)[1];
                
                var result = await apiCall('uploadImage', {
                    fileName: fileName,
                    base64Data: base64Content,
                    mimeType: mimeType
                });
                
                if (result.success) {
                    return result.url;
                } else {
                    console.error('ä¸Šå‚³å¤±æ•—:', result.error);
                    return '';
                }
            } catch (err) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', err);
                return '';
            }
        }

        // ===== æ¸²æŸ“åç‰‡ =====
        function renderCards() {
            var grid = document.getElementById('cardsGrid');
            var search = document.getElementById('searchInput').value.toLowerCase();
            
            var filtered = cards.filter(function(card) {
                var matchSearch = !search || 
                    (card.name && card.name.toLowerCase().includes(search)) ||
                    (card.nameEn && card.nameEn.toLowerCase().includes(search)) ||
                    (card.company && card.company.toLowerCase().includes(search)) ||
                    (card.lineId && card.lineId.toLowerCase().includes(search)) ||
                    (card.notes && card.notes.toLowerCase().includes(search));
                var matchCat = currentCategory === 'å…¨éƒ¨' || card.category === currentCategory;
                return matchSearch && matchCat;
            });

            document.getElementById('totalCount').textContent = cards.length;
            document.getElementById('lineCount').textContent = cards.filter(function(c) { return c.lineId; }).length;
            document.getElementById('filterCount').textContent = filtered.length;

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">ğŸ“­</div><h3>' + 
                    (cards.length === 0 ? 'é‚„æ²’æœ‰åç‰‡ï¼Œé»æ“Šã€Œæ–°å¢ã€é–‹å§‹' : 'æ‰¾ä¸åˆ°ç¬¦åˆçš„åç‰‡') + '</h3></div>';
                return;
            }

            grid.innerHTML = filtered.map(function(card) {
                var avatarStyle = card.avatarUrl ? 'background-image:url("' + card.avatarUrl + '");color:transparent;' : '';
                var hasImages = card.cardFrontUrl || card.cardBackUrl;
                
                return '<div class="card" onclick="openDetailModal(\'' + card.id + '\')">' +
                    '<span class="card-category cat-' + (card.category || 'å…¶ä»–') + '">' + (card.category || 'å…¶ä»–') + '</span>' +
                    '<div class="card-header">' +
                        '<div class="card-avatar avatar-' + (card.category || 'å…¶ä»–') + '" style="' + avatarStyle + '">' + (card.avatarUrl ? '' : (card.name ? card.name.charAt(0) : '?')) + '</div>' +
                        '<div>' +
                            '<div class="card-name">' + escapeHtml(card.name) + '</div>' +
                            (card.nameEn ? '<div class="card-name-en">' + escapeHtml(card.nameEn) + '</div>' : '') +
                            '<div class="card-title">' + (escapeHtml(card.title) || 'â€”') + '</div>' +
                        '</div>' +
                    '</div>' +
                    (card.company ? '<div class="card-company">ğŸ¢ ' + escapeHtml(card.company) + '</div>' : '') +
                    '<div class="card-contacts">' +
                        (card.phone ? '<div class="card-contact">ğŸ“± ' + escapeHtml(card.phone) + '</div>' : '') +
                        (card.lineId ? '<div class="card-contact card-line">ğŸ’¬ ' + escapeHtml(card.lineId) + '</div>' : '') +
                    '</div>' +
                    (hasImages ? '<div class="card-images">' +
                        (card.cardFrontUrl ? '<div class="card-image-thumb" style="background-image:url(\'' + card.cardFrontUrl + '\')"></div>' : '') +
                        (card.cardBackUrl ? '<div class="card-image-thumb" style="background-image:url(\'' + card.cardBackUrl + '\')"></div>' : '') +
                    '</div>' : '') +
                '</div>';
            }).join('');
        }

        function filterCards() { renderCards(); }

        function selectCategory(btn) {
            document.querySelectorAll('.category-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentCategory = btn.dataset.cat;
            renderCards();
        }

        // ===== Modal =====
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'â• æ–°å¢åç‰‡';
            clearForm();
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function clearForm() {
            document.getElementById('cardName').value = '';
            document.getElementById('cardNameEn').value = '';
            document.getElementById('cardCompany').value = '';
            document.getElementById('cardTitle').value = '';
            document.getElementById('cardPhone').value = '';
            document.getElementById('cardEmail').value = '';
            document.getElementById('cardLine').value = '';
            document.getElementById('cardCategory').value = 'å®¢æˆ¶';
            document.getElementById('cardAddress').value = '';
            document.getElementById('cardWebsite').value = '';
            document.getElementById('cardNotes').value = '';
            
            cardFrontImage = null;
            cardBackImage = null;
            avatarImage = null;
            cardFrontUrl = '';
            cardBackUrl = '';
            avatarUrl = '';
            
            document.getElementById('cardFrontBox').innerHTML = '<span class="image-box-icon">ğŸ“„</span><span class="image-box-label">æ­£é¢</span>';
            document.getElementById('cardFrontBox').classList.remove('has-image');
            document.getElementById('cardBackBox').innerHTML = '<span class="image-box-icon">ğŸ“„</span><span class="image-box-label">èƒŒé¢</span>';
            document.getElementById('cardBackBox').classList.remove('has-image');
            document.getElementById('avatarPreview').style.backgroundImage = '';
            document.getElementById('avatarPreview').classList.remove('has-image');
            document.getElementById('avatarPreview').textContent = 'ğŸ‘¤';
            document.getElementById('recognizeBtn').disabled = true;
            document.getElementById('ocrResult').classList.remove('active');
        }

        // ===== å„²å­˜åç‰‡ =====
        async function saveCard() {
            var name = document.getElementById('cardName').value.trim();
            if (!name) {
                showNotification('è«‹è¼¸å…¥å§“å', 'error');
                return;
            }

            var saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading"></span>';
            showLoading('å„²å­˜ä¸­...');

            try {
                // ä¸Šå‚³åœ–ç‰‡åˆ° Google Drive
                var uploadedFrontUrl = cardFrontUrl;
                var uploadedBackUrl = cardBackUrl;
                var uploadedAvatarUrl = avatarUrl;

                if (cardFrontImage && !cardFrontUrl) {
                    showLoading('ä¸Šå‚³åç‰‡æ­£é¢...');
                    uploadedFrontUrl = await uploadImageToDrive(cardFrontImage, 'card_front_' + Date.now() + '.jpg');
                }
                if (cardBackImage && !cardBackUrl) {
                    showLoading('ä¸Šå‚³åç‰‡èƒŒé¢...');
                    uploadedBackUrl = await uploadImageToDrive(cardBackImage, 'card_back_' + Date.now() + '.jpg');
                }
                if (avatarImage && !avatarUrl) {
                    showLoading('ä¸Šå‚³å¤§é ­ç…§...');
                    uploadedAvatarUrl = await uploadImageToDrive(avatarImage, 'avatar_' + Date.now() + '.jpg');
                }

                var cardData = {
                    'ID': editingId || String(Date.now()),
                    'å§“å': name,
                    'è‹±æ–‡å': document.getElementById('cardNameEn').value.trim(),
                    'å…¬å¸': document.getElementById('cardCompany').value.trim(),
                    'è·ç¨±': document.getElementById('cardTitle').value.trim(),
                    'é›»è©±': document.getElementById('cardPhone').value.trim(),
                    'Email': document.getElementById('cardEmail').value.trim(),
                    'LINE_ID': document.getElementById('cardLine').value.trim(),
                    'åˆ†é¡': document.getElementById('cardCategory').value,
                    'åœ°å€': document.getElementById('cardAddress').value.trim(),
                    'ç¶²ç«™': document.getElementById('cardWebsite').value.trim(),
                    'å‚™è¨»': document.getElementById('cardNotes').value.trim(),
                    'åç‰‡æ­£é¢': uploadedFrontUrl,
                    'åç‰‡èƒŒé¢': uploadedBackUrl,
                    'å¤§é ­ç…§': uploadedAvatarUrl
                };

                showLoading('å„²å­˜åˆ°é›²ç«¯...');
                
                var action = editingId ? 'update' : 'add';
                var result = await apiCall(action, { card: cardData });

                if (result.success) {
                    showNotification('âœ… ' + result.message, 'success');
                    closeAddModal();
                    await syncFromCloud();
                } else {
                    throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (err) {
                console.error('å„²å­˜éŒ¯èª¤:', err);
                showNotification('å„²å­˜å¤±æ•—: ' + err.message, 'error');
            }

            hideLoading();
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'ğŸ’¾ å„²å­˜';
        }

        // ===== è©³ç´°é  =====
        function openDetailModal(id) {
            var card = cards.find(function(c) { return c.id === id; });
            if (!card) return;

            var avatarStyle = card.avatarUrl ? 'background-image:url("' + card.avatarUrl + '");color:transparent;' : '';
            var hasImages = card.cardFrontUrl || card.cardBackUrl;
            
            var imagesHtml = '';
            if (hasImages) {
                imagesHtml = '<div class="detail-images">';
                if (card.cardFrontUrl) {
                    imagesHtml += '<div class="detail-image"><img src="' + card.cardFrontUrl + '" alt="æ­£é¢"><div class="detail-image-label">æ­£é¢</div></div>';
                }
                if (card.cardBackUrl) {
                    imagesHtml += '<div class="detail-image"><img src="' + card.cardBackUrl + '" alt="èƒŒé¢"><div class="detail-image-label">èƒŒé¢</div></div>';
                }
                imagesHtml += '</div>';
            }

            document.getElementById('detailContent').innerHTML = 
                imagesHtml +
                '<div class="detail-header">' +
                    '<div class="detail-avatar avatar-' + (card.category || 'å…¶ä»–') + '" style="' + avatarStyle + '">' + (card.avatarUrl ? '' : card.name.charAt(0)) + '</div>' +
                    '<div class="detail-info">' +
                        '<h2>' + escapeHtml(card.name) + '</h2>' +
                        (card.nameEn ? '<div class="name-en">' + escapeHtml(card.nameEn) + '</div>' : '') +
                        '<p>' + (escapeHtml(card.title) || 'â€”') + '</p>' +
                        '<span class="detail-category cat-' + (card.category || 'å…¶ä»–') + '">' + (card.category || 'å…¶ä»–') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="detail-section">' +
                    (card.company ? '<div class="detail-row"><span class="detail-row-icon">ğŸ¢</span><span class="detail-row-label">å…¬å¸</span><span class="detail-row-value">' + escapeHtml(card.company) + '</span></div>' : '') +
                    (card.phone ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“±</span><span class="detail-row-label">é›»è©±</span><span class="detail-row-value"><a href="tel:' + card.phone + '">' + escapeHtml(card.phone) + '</a></span></div>' : '') +
                    (card.lineId ? '<div class="detail-row"><span class="detail-row-icon">ğŸ’¬</span><span class="detail-row-label">LINE</span><span class="detail-row-value line"><a href="https://line.me/ti/p/~' + card.lineId + '" target="_blank">' + escapeHtml(card.lineId) + '</a></span></div>' : '') +
                    (card.email ? '<div class="detail-row"><span class="detail-row-icon">âœ‰ï¸</span><span class="detail-row-label">Email</span><span class="detail-row-value"><a href="mailto:' + card.email + '">' + escapeHtml(card.email) + '</a></span></div>' : '') +
                    (card.address ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“</span><span class="detail-row-label">åœ°å€</span><span class="detail-row-value">' + escapeHtml(card.address) + '</span></div>' : '') +
                    (card.website ? '<div class="detail-row"><span class="detail-row-icon">ğŸŒ</span><span class="detail-row-label">ç¶²ç«™</span><span class="detail-row-value"><a href="' + (card.website.startsWith('http') ? card.website : 'https://' + card.website) + '" target="_blank">' + escapeHtml(card.website) + '</a></span></div>' : '') +
                '</div>' +
                (card.notes ? '<div class="detail-notes"><h4>ğŸ“ å‚™è¨»</h4><p>' + escapeHtml(card.notes) + '</p></div>' : '') +
                '<div class="form-actions">' +
                    '<button class="btn btn-danger" onclick="deleteCard(\'' + card.id + '\')">ğŸ—‘ï¸ åˆªé™¤</button>' +
                    '<button class="btn btn-primary" onclick="openEditModal(\'' + card.id + '\')">âœï¸ ç·¨è¼¯</button>' +
                '</div>';

            document.getElementById('detailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function openEditModal(id) {
            var card = cards.find(function(c) { return c.id === id; });
            if (!card) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'âœï¸ ç·¨è¼¯åç‰‡';
            
            document.getElementById('cardName').value = card.name || '';
            document.getElementById('cardNameEn').value = card.nameEn || '';
            document.getElementById('cardCompany').value = card.company || '';
            document.getElementById('cardTitle').value = card.title || '';
            document.getElementById('cardPhone').value = card.phone || '';
            document.getElementById('cardEmail').value = card.email || '';
            document.getElementById('cardLine').value = card.lineId || '';
            document.getElementById('cardCategory').value = card.category || 'å®¢æˆ¶';
            document.getElementById('cardAddress').value = card.address || '';
            document.getElementById('cardWebsite').value = card.website || '';
            document.getElementById('cardNotes').value = card.notes || '';

            // è¨­å®šç¾æœ‰åœ–ç‰‡ URL
            cardFrontUrl = card.cardFrontUrl || '';
            cardBackUrl = card.cardBackUrl || '';
            avatarUrl = card.avatarUrl || '';
            cardFrontImage = null;
            cardBackImage = null;
            avatarImage = null;

            if (cardFrontUrl) {
                document.getElementById('cardFrontBox').innerHTML = '<img src="' + cardFrontUrl + '" alt="æ­£é¢">';
                document.getElementById('cardFrontBox').classList.add('has-image');
            }
            if (cardBackUrl) {
                document.getElementById('cardBackBox').innerHTML = '<img src="' + cardBackUrl + '" alt="èƒŒé¢">';
                document.getElementById('cardBackBox').classList.add('has-image');
            }
            if (avatarUrl) {
                document.getElementById('avatarPreview').style.backgroundImage = 'url("' + avatarUrl + '")';
                document.getElementById('avatarPreview').classList.add('has-image');
                document.getElementById('avatarPreview').textContent = '';
            }

            closeDetailModal();
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function deleteCard(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™å¼µåç‰‡ï¼Ÿ')) return;

            showLoading('åˆªé™¤ä¸­...');

            try {
                var result = await apiCall('delete', { id: id });

                if (result.success) {
                    showNotification('ğŸ—‘ï¸ å·²åˆªé™¤', 'success');
                    closeDetailModal();
                    await syncFromCloud();
                } else {
                    throw new Error(result.error || 'åˆªé™¤å¤±æ•—');
                }
            } catch (err) {
                console.error('åˆªé™¤éŒ¯èª¤:', err);
                showNotification('åˆªé™¤å¤±æ•—: ' + err.message, 'error');
            }

            hideLoading();
        }

        // ===== OCR è¾¨è­˜ =====
        async function recognizeCard() {
            if (!cardFrontImage) return;

            var btn = document.getElementById('recognizeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';
            showLoading('è¾¨è­˜ä¸­...');

            try {
                var base64Content = cardFrontImage.split(',')[1];
                var result = await apiCall('ocr', { base64Image: base64Content });

                console.log('OCR çµæœ:', result);

                if (result.success && result.text) {
                    document.getElementById('ocrText').textContent = result.text;
                    document.getElementById('ocrResult').classList.add('active');
                    parseBusinessCard(result.text);
                    showNotification('âœ… è¾¨è­˜å®Œæˆ', 'success');
                } else {
                    throw new Error(result.error || 'ç„¡æ³•è¾¨è­˜');
                }
            } catch (err) {
                console.error('OCR éŒ¯èª¤:', err);
                showNotification('è¾¨è­˜å¤±æ•—: ' + err.message, 'error');
            }

            hideLoading();
            btn.disabled = false;
            btn.innerHTML = 'ğŸ” è¾¨è­˜';
        }

        // ===== è§£æåç‰‡ =====
        function parseBusinessCard(text) {
            var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
            var allText = text;
            var usedLines = [];

            // Email
            var emailMatch = allText.match(/[\w.-]+@[\w.-]+\.\w+/);
            if (emailMatch) {
                document.getElementById('cardEmail').value = emailMatch[0];
            }

            // é›»è©±
            var phonePatterns = [
                /09\d{2}[-\s]?\d{3}[-\s]?\d{3}/g,
                /0\d{1,2}[-\s]?\d{3,4}[-\s]?\d{3,4}/g,
                /\(\d{2,3}\)[-\s]?\d{3,4}[-\s]?\d{3,4}/g,
                /\+886[-\s]?\d+[-\s]?\d+[-\s]?\d+/g
            ];
            
            for (var p = 0; p < phonePatterns.length; p++) {
                var match = allText.match(phonePatterns[p]);
                if (match) {
                    document.getElementById('cardPhone').value = match[0];
                    break;
                }
            }

            // LINE ID
            var lineMatch = allText.match(/(?:LINE|Line|line)[\s:ï¼šID]*([\w._-]+)/i);
            if (lineMatch && lineMatch[1] && lineMatch[1].length > 2) {
                document.getElementById('cardLine').value = lineMatch[1];
            }

            // ç¶²ç«™
            var webMatch = allText.match(/(?:www\.[\w.-]+\.\w+)|(?:https?:\/\/[\w.-]+)/i);
            if (webMatch) {
                document.getElementById('cardWebsite').value = webMatch[0];
            }

            // å…¬å¸
            var companyKeywords = [
                'è‚¡ä»½æœ‰é™å…¬å¸', 'æœ‰é™å…¬å¸', 'å…¬å¸', 'ä¼æ¥­', 'é›†åœ˜', 
                'äº‹å‹™æ‰€', 'å·¥ä½œå®¤', 'è¨ºæ‰€', 'é†«é™¢', 'éŠ€è¡Œ', 'è­‰åˆ¸',
                'å­¸é™¢', 'å¤§å­¸', 'å­¸æ ¡', 'å”æœƒ', 'åŸºé‡‘æœƒ', 'å•†è¡Œ',
                'å·¥å» ', 'å¯¦æ¥­', 'ç§‘æŠ€', 'é¡§å•', 'è¨­è¨ˆ', 'åœ‹éš›',
                'Co.', 'Corp', 'Inc', 'Ltd', 'LLC', 'Company', 'Group'
            ];
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                for (var j = 0; j < companyKeywords.length; j++) {
                    if (line.includes(companyKeywords[j])) {
                        document.getElementById('cardCompany').value = line;
                        usedLines.push(line);
                        break;
                    }
                }
                if (document.getElementById('cardCompany').value) break;
            }

            // è·ç¨±
            var titleKeywords = [
                'è‘£äº‹é•·', 'ç¸½ç¶“ç†', 'å‰¯ç¸½', 'å”ç†', 'ç¶“ç†', 'å‰¯ç†', 'è¥„ç†',
                'ç¸½ç›£', 'ä¸»ç®¡', 'å°ˆå“¡', 'çµ„é•·', 'èª²é•·', 'åº—é•·', 'å» é•·',
                'å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'å»ºç¯‰å¸«', 'æœƒè¨ˆå¸«', 'å¾‹å¸«', 'é†«å¸«', 'è—¥å¸«',
                'é¡§å•', 'æ¥­å‹™', 'ç§˜æ›¸', 'åŠ©ç†', 'ç¸½è£', 'åŸ·è¡Œé•·',
                'CEO', 'CTO', 'CFO', 'COO', 'VP', 'Director', 'Manager', 
                'Engineer', 'Designer', 'Consultant', 'President'
            ];
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (usedLines.includes(line)) continue;
                
                for (var j = 0; j < titleKeywords.length; j++) {
                    if (line.includes(titleKeywords[j])) {
                        document.getElementById('cardTitle').value = line;
                        usedLines.push(line);
                        break;
                    }
                }
                if (document.getElementById('cardTitle').value) break;
            }

            // å§“åï¼ˆå¸¸è¦‹å§“æ°ï¼‰
            var commonSurnames = ['é™³', 'æ—', 'é»ƒ', 'å¼µ', 'æ', 'ç‹', 'å³', 'åŠ‰', 'è”¡', 'æ¥Š', 
                'è¨±', 'é„­', 'è¬', 'éƒ­', 'æ´ª', 'æ›¾', 'é‚±', 'å»–', 'è³´', 'å‘¨', 'å¾', 'è˜‡', 'è‘‰',
                'èŠ', 'å‘‚', 'æ±Ÿ', 'ä½•', 'è•­', 'ç¾…', 'é«˜', 'æ½˜', 'ç°¡', 'æœ±', 'é¾', 'æ¸¸', 'è©¹',
                'å½­', 'æ–½', 'æ²ˆ', 'ä½™', 'ç›§', 'æ¢', 'è¶™', 'é¡', 'æŸ¯', 'ç¿', 'é­', 'å­«', 'æˆ´',
                'èŒƒ', 'æ–¹', 'å®‹', 'é„§', 'æœ', 'å‚…', 'ä¾¯', 'æ›¹', 'è–›', 'ä¸', 'å“', 'é¦¬', 'é˜®',
                'è‘£', 'æ¸©', 'å”', 'è—', 'çŸ³', 'è”£', 'å¤', 'ç´€', 'å§š', 'é€£', 'é¦®', 'æ­', 'ç¨‹',
                'æ¹¯', 'é»', 'ç”°', 'åº·', 'é„’', 'ç™½', 'æ¶‚', 'å°¤', 'å·«', 'éŸ“', 'é¾”', 'åš´', 'è¢'];
            
            var foundName = false;
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (usedLines.includes(line)) continue;
                if (line.includes('@') || line.includes('www') || line.match(/\d{4,}/)) continue;
                
                if (/^[\u4e00-\u9fa5]{2,4}$/.test(line)) {
                    var firstChar = line.charAt(0);
                    if (commonSurnames.includes(firstChar)) {
                        document.getElementById('cardName').value = line;
                        usedLines.push(line);
                        foundName = true;
                        break;
                    }
                }
            }
            
            if (!foundName) {
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];
                    if (usedLines.includes(line)) continue;
                    if (line.includes('@') || line.includes('www') || line.match(/\d{4,}/)) continue;
                    
                    if (/^[\u4e00-\u9fa5]{2,4}$/.test(line)) {
                        document.getElementById('cardName').value = line;
                        usedLines.push(line);
                        break;
                    }
                }
            }

            // è‹±æ–‡å
            var englishNamePattern = /^[A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2}$/;
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (usedLines.includes(line)) continue;
                if (line.includes('@') || line.includes('www') || line.includes('.com')) continue;
                
                if (englishNamePattern.test(line) && line.length > 3 && line.length < 30) {
                    document.getElementById('cardNameEn').value = line;
                    break;
                }
            }

            // åœ°å€
            var addressKeywords = ['å¸‚', 'ç¸£', 'å€', 'é„‰', 'é®', 'è·¯', 'è¡—', 'å··', 'å¼„', 'è™Ÿ', 'æ¨“'];
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                var matchCount = 0;
                for (var j = 0; j < addressKeywords.length; j++) {
                    if (line.includes(addressKeywords[j])) matchCount++;
                }
                if (matchCount >= 3) {
                    document.getElementById('cardAddress').value = line;
                    break;
                }
            }
        }

        // ===== å·¥å…· =====
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ===== éµç›¤äº‹ä»¶ =====
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddModal();
                closeDetailModal();
            }
        });

        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });
    </script>
</body>
</html>
