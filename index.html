<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>åç‰‡ç®¡ç†ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #06d6a0;
            --primary-dark: #00b890;
            --accent: #3b82f6;
            --bg-dark: #0f172a;
            --bg-card: rgba(255,255,255,0.06);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255,255,255,0.1);
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(6, 214, 160, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text h1 { font-size: 18px; font-weight: 700; }
        .logo-text p { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .search-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 180px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 38px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box input:focus { border-color: var(--primary); }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .categories {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .category-btn {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.08);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: transparent;
            font-weight: 600;
        }

        .category-manage-btn {
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            border: 1px dashed var(--border);
        }

        .main {
            padding: 16px;
            position: relative;
            z-index: 1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-value.primary { color: var(--primary); }
        .stat-value.accent { color: var(--accent); }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 14px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            border-color: rgba(6, 214, 160, 0.3);
        }

        .card-category {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-avatar {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .card-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .card-name-en { font-size: 12px; color: var(--text-muted); }
        .card-title { font-size: 12px; color: var(--text-secondary); }
        .card-company { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; }
        .card-contacts { display: flex; flex-direction: column; gap: 6px; }
        .card-contact { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }

        .card-line {
            background: rgba(6, 214, 160, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(6, 214, 160, 0.2);
            color: var(--primary);
            font-weight: 500;
        }

        .card-images {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .card-image-thumb {
            flex: 1;
            height: 50px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 200;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            overflow-y: auto;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 480px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h2 { font-size: 18px; font-weight: 700; }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
        }

        .form-group { margin-bottom: 12px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }

        .form-input:focus { border-color: var(--primary); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input.highlight { background: rgba(6, 214, 160, 0.1); border-color: rgba(6, 214, 160, 0.3); }
        textarea.form-input { resize: vertical; min-height: 60px; }

        .form-input-row {
            display: flex;
            gap: 8px;
        }

        .form-input-row .form-input { flex: 1; }

        .form-input-row .btn {
            padding: 10px 12px;
            flex-shrink: 0;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .form-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 12px;
        }

        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .image-section {
            margin-bottom: 14px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            border: 1px dashed var(--border);
        }

        .image-section-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .image-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .image-box {
            flex: 1;
            aspect-ratio: 16/10;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-box.has-image {
            border-style: solid;
            border-color: var(--primary);
        }

        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-box-label {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        .image-box-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .image-btns {
            display: flex;
            gap: 8px;
        }

        .image-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .image-btn.camera { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; }
        .image-btn.gallery { background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--border); }
        .image-btn.recognize { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .image-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* å¤§é ­ç…§ */
        .avatar-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
        }

        .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-size: cover;
            background-position: center;
            border: 2px dashed var(--border);
            flex-shrink: 0;
        }

        .avatar-preview.has-image { border-style: solid; border-color: var(--primary); }
        .avatar-info { flex: 1; }
        .avatar-info h4 { font-size: 13px; margin-bottom: 3px; }
        .avatar-info p { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }

        .avatar-btns {
            display: flex;
            gap: 6px;
        }

        .avatar-btn {
            padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }

        /* OCR çµæœ - å¯é¸æ“‡æ¬„ä½ */
        .ocr-result {
            margin-top: 10px;
            padding: 12px;
            background: rgba(6, 214, 160, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(6, 214, 160, 0.2);
            display: none;
        }

        .ocr-result.active { display: block; }
        
        .ocr-result h4 { 
            color: var(--primary); 
            margin-bottom: 8px; 
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ocr-lines {
            max-height: 200px;
            overflow-y: auto;
        }

        .ocr-line {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-size: 13px;
        }

        .ocr-line-text {
            flex: 1;
            word-break: break-all;
        }

        .ocr-line-btns {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .ocr-field-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .ocr-field-btn:hover {
            background: var(--primary);
            color: white;
        }

        .ocr-field-btn.used {
            background: var(--success);
            color: white;
        }

        /* è©³ç´°é  */
        .detail-header { display: flex; gap: 12px; margin-bottom: 14px; }

        .detail-avatar {
            width: 65px;
            height: 65px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .detail-info h2 { font-size: 22px; margin-bottom: 2px; }
        .detail-info .name-en { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
        .detail-info p { color: var(--text-secondary); font-size: 13px; }

        .detail-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 5px;
            background: rgba(255,255,255,0.1);
        }

        .detail-images {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }

        .detail-image {
            flex: 1;
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .detail-image img {
            width: 100%;
            display: block;
        }

        .detail-image-label {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            padding: 4px;
            background: rgba(0,0,0,0.3);
        }

        .detail-section {
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            padding: 7px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-row-icon { font-size: 14px; margin-right: 8px; }
        .detail-row-label { width: 55px; font-size: 11px; color: var(--text-muted); }
        .detail-row-value { flex: 1; font-size: 13px; word-break: break-all; }
        .detail-row-value a { color: var(--text-primary); text-decoration: none; }
        .detail-row-value a:hover { color: var(--primary); }
        .detail-row-value.line { color: var(--primary); font-weight: 500; }

        .detail-notes { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
        .detail-notes h4 { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
        .detail-notes p { font-size: 13px; line-height: 1.5; }

        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 45px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state h3 { font-size: 15px; margin-bottom: 6px; color: var(--text-secondary); }

        .notification {
            position: fixed;
            top: calc(10px + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 300;
            transition: transform 0.3s;
            font-size: 13px;
            max-width: 90%;
            text-align: center;
        }

        .notification.active { transform: translateX(-50%) translateY(0); }
        .notification.error { background: var(--danger); }
        .notification.success { background: var(--success); }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .sync-status { font-size: 10px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); }
        .sync-dot.online { background: var(--success); }
        .sync-dot.syncing { background: var(--accent); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .hidden-input { display: none; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 400;
        }

        .loading-overlay.active { display: flex; }
        .loading-overlay .loading { width: 40px; height: 40px; border-width: 3px; }
        .loading-overlay p { color: var(--text-secondary); font-size: 14px; }

        /* åˆ†é¡ç®¡ç† Modal */
        .category-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .category-item-name {
            font-size: 14px;
        }

        .category-item-delete {
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.1);
            border: none;
            border-radius: 4px;
            color: #f87171;
            font-size: 12px;
            cursor: pointer;
        }

        .add-category-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-category-row input {
            flex: 1;
        }

        @media (max-width: 480px) {
            .header-top { flex-wrap: wrap; }
            .form-row { grid-template-columns: 1fr; }
            .cards-grid { grid-template-columns: 1fr; }
            .avatar-section { flex-direction: column; text-align: center; }
            .avatar-btns { justify-content: center; }
            .ocr-line { flex-direction: column; align-items: flex-start; }
            .ocr-line-btns { margin-top: 6px; flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div id="loadingOverlay" class="loading-overlay">
        <span class="loading"></span>
        <p id="loadingText">è¼‰å…¥ä¸­...</p>
    </div>

    <input type="file" id="cardFrontCameraInput" class="hidden-input" accept="image/*" capture="environment">
    <input type="file" id="cardFrontGalleryInput" class="hidden-input" accept="image/*">
    <input type="file" id="cardBackCameraInput" class="hidden-input" accept="image/*" capture="environment">
    <input type="file" id="cardBackGalleryInput" class="hidden-input" accept="image/*">
    <input type="file" id="avatarCameraInput" class="hidden-input" accept="image/*" capture="user">
    <input type="file" id="avatarGalleryInput" class="hidden-input" accept="image/*">

    <header class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-icon">ğŸ“‡</div>
                <div class="logo-text">
                    <h1>åç‰‡ç®¡ç†ä¸­å¿ƒ</h1>
                    <p>â˜ï¸ é›²ç«¯åŒæ­¥ç‰ˆ v6</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="sync-status">
                    <span class="sync-dot" id="syncDot"></span>
                    <span id="syncText">é›¢ç·š</span>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="syncFromCloud()" title="åŒæ­¥è³‡æ–™">ğŸ”„</button>
                <button class="btn btn-primary" onclick="openAddModal()">â• æ–°å¢</button>
            </div>
        </div>
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€å…¬å¸ã€LINE..." oninput="filterCards()">
            </div>
            <div class="categories" id="categories"></div>
        </div>
    </header>

    <main class="main">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š ç¸½åç‰‡</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¬ æœ‰LINE</div>
                <div class="stat-value primary" id="lineCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ” çµæœ</div>
                <div class="stat-value accent" id="filterCount">0</div>
            </div>
        </div>
        <div class="cards-grid" id="cardsGrid"></div>
    </main>

    <!-- æ–°å¢/ç·¨è¼¯ Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">â• æ–°å¢åç‰‡</h2>
                <button class="modal-close" onclick="closeAddModal()">âœ•</button>
            </div>

            <div class="image-section">
                <div class="image-section-title">ğŸ“¸ åç‰‡ç…§ç‰‡</div>
                <div class="image-row">
                    <div class="image-box" id="cardFrontBox">
                        <span class="image-box-icon">ğŸ“„</span>
                        <span class="image-box-label">æ­£é¢</span>
                    </div>
                    <div class="image-box" id="cardBackBox">
                        <span class="image-box-icon">ğŸ“„</span>
                        <span class="image-box-label">èƒŒé¢</span>
                    </div>
                </div>
                <div class="image-btns">
                    <button type="button" class="image-btn camera" onclick="captureCard('front')">ğŸ“· æ‹æ­£é¢</button>
                    <button type="button" class="image-btn gallery" onclick="selectCard('front')">ğŸ–¼ï¸ é¸æ­£é¢</button>
                    <button type="button" class="image-btn recognize" id="recognizeBtn" onclick="recognizeCard()" disabled>ğŸ” è¾¨è­˜</button>
                </div>
                <div class="image-btns" style="margin-top:6px;">
                    <button type="button" class="image-btn camera" onclick="captureCard('back')">ğŸ“· æ‹èƒŒé¢</button>
                    <button type="button" class="image-btn gallery" onclick="selectCard('back')">ğŸ–¼ï¸ é¸èƒŒé¢</button>
                </div>
                
                <!-- OCR çµæœ - å¯é¸æ“‡å¡«å…¥æ¬„ä½ -->
                <div class="ocr-result" id="ocrResult">
                    <h4>ğŸ“ é»æ“ŠæŒ‰éˆ•å¡«å…¥å°æ‡‰æ¬„ä½</h4>
                    <div class="ocr-lines" id="ocrLines"></div>
                </div>
            </div>

            <div class="avatar-section">
                <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                <div class="avatar-info">
                    <h4>ğŸ“¸ å¤§é ­ç…§</h4>
                    <p>ä¸Šå‚³è¯çµ¡äººç…§ç‰‡</p>
                    <div class="avatar-btns">
                        <button type="button" class="avatar-btn" onclick="captureAvatar()">ğŸ“· æ‹ç…§</button>
                        <button type="button" class="avatar-btn" onclick="selectAvatar()">ğŸ–¼ï¸ é¸æ“‡</button>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ å§“åï¼ˆä¸­æ–‡ï¼‰*</label>
                    <input type="text" class="form-input" id="cardName" placeholder="ç‹å¤§æ˜">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ”¤ è‹±æ–‡å</label>
                    <input type="text" class="form-input" id="cardNameEn" placeholder="David Wang">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ¢ å…¬å¸</label>
                    <input type="text" class="form-input" id="cardCompany" placeholder="å°ç£ç§‘æŠ€å…¬å¸">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ åˆ†é¡</label>
                    <div class="form-input-row">
                        <select class="form-input" id="cardCategory"></select>
                        <button type="button" class="btn btn-secondary" onclick="openCategoryModal()">âš™ï¸</button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ’¼ è·ç¨±</label>
                <input type="text" class="form-input" id="cardTitle" placeholder="æ¥­å‹™ç¶“ç†">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ“± é›»è©±</label>
                    <input type="tel" class="form-input" id="cardPhone" placeholder="0912-345-678">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’¬ LINE ID</label>
                    <input type="text" class="form-input highlight" id="cardLine" placeholder="line_id">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">âœ‰ï¸ Email</label>
                <input type="email" class="form-input" id="cardEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ“ åœ°å€</label>
                <input type="text" class="form-input" id="cardAddress" placeholder="å°åŒ—å¸‚...">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸŒ ç¶²ç«™</label>
                <input type="text" class="form-input" id="cardWebsite" placeholder="www.example.com">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ“ å‚™è¨»</label>
                <textarea class="form-input" id="cardNotes" placeholder="å‚™è¨»..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveCard()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- è©³ç´° Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ“‡ åç‰‡è©³æƒ…</h2>
                <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- åˆ†é¡ç®¡ç† Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h2>âš™ï¸ ç®¡ç†åˆ†é¡</h2>
                <button class="modal-close" onclick="closeCategoryModal()">âœ•</button>
            </div>
            <div class="category-list" id="categoryList"></div>
            <div class="add-category-row">
                <input type="text" class="form-input" id="newCategoryInput" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±...">
                <button class="btn btn-primary" onclick="addNewCategory()">â• æ–°å¢</button>
            </div>
        </div>
    </div>

    <script>
        // ===== API è¨­å®š =====
        const API_URL = 'https://script.google.com/macros/s/AKfycbxsDT1GpMUWkLTh8HQIB6QMVOM6aMXS2IvBy1hpWy_y5mgyOakb__p0XQm1cn2q6N0LVQ/exec';

        // ===== å…¨åŸŸè®Šæ•¸ =====
        let cards = [];
        let categories = ['å®¢æˆ¶', 'ä¾›æ‡‰å•†', 'åˆä½œå¤¥ä¼´', 'åŒäº‹', 'æœ‹å‹', 'å…¶ä»–'];
        let currentCategory = 'å…¨éƒ¨';
        let cardFrontImage = null;
        let cardBackImage = null;
        let avatarImage = null;
        let cardFrontUrl = '';
        let cardBackUrl = '';
        let avatarUrl = '';
        let editingId = null;
        let ocrLines = [];

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App v6 åˆå§‹åŒ–...');
            initFileInputs();
            loadFromLocal();
            loadCategories();
            syncFromCloud();
        });

        // ===== è¼‰å…¥åˆ†é¡ =====
        async function loadCategories() {
            try {
                var response = await fetch(API_URL + '?type=categories');
                var result = await response.json();
                if (result.success && result.categories) {
                    categories = result.categories;
                    localStorage.setItem('categories_v6', JSON.stringify(categories));
                }
            } catch (err) {
                console.error('è¼‰å…¥åˆ†é¡å¤±æ•—:', err);
                var saved = localStorage.getItem('categories_v6');
                if (saved) {
                    categories = JSON.parse(saved);
                }
            }
            renderCategoryButtons();
            renderCategorySelect();
        }

        function renderCategoryButtons() {
            var container = document.getElementById('categories');
            var btns = '<button class="category-btn active" data-cat="å…¨éƒ¨" onclick="selectCategory(this)">å…¨éƒ¨</button>';
            for (var i = 0; i < categories.length; i++) {
                btns += '<button class="category-btn" data-cat="' + categories[i] + '" onclick="selectCategory(this)">' + categories[i] + '</button>';
            }
            btns += '<button class="category-manage-btn" onclick="openCategoryModal()">âš™ï¸</button>';
            container.innerHTML = btns;
        }

        function renderCategorySelect() {
            var select = document.getElementById('cardCategory');
            select.innerHTML = categories.map(function(c) {
                return '<option value="' + c + '">' + c + '</option>';
            }).join('');
        }

        // ===== åˆ†é¡ç®¡ç† =====
        function openCategoryModal() {
            renderCategoryList();
            document.getElementById('categoryModal').classList.add('active');
            document.getElementById('newCategoryInput').value = '';
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        function renderCategoryList() {
            var list = document.getElementById('categoryList');
            list.innerHTML = categories.map(function(c) {
                return '<div class="category-item">' +
                    '<span class="category-item-name">' + escapeHtml(c) + '</span>' +
                    '<button class="category-item-delete" onclick="deleteCategory(\'' + escapeHtml(c) + '\')">ğŸ—‘ï¸</button>' +
                '</div>';
            }).join('');
        }

        async function addNewCategory() {
            var input = document.getElementById('newCategoryInput');
            var name = input.value.trim();
            if (!name) {
                showNotification('è«‹è¼¸å…¥åˆ†é¡åç¨±', 'error');
                return;
            }

            showLoading('æ–°å¢åˆ†é¡...');
            try {
                var result = await apiCall('addCategory', { category: name });
                if (result.success) {
                    showNotification('âœ… åˆ†é¡å·²æ–°å¢', 'success');
                    input.value = '';
                    await loadCategories();
                    renderCategoryList();
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                showNotification('æ–°å¢å¤±æ•—: ' + err.message, 'error');
            }
            hideLoading();
        }

        async function deleteCategory(name) {
            if (!confirm('ç¢ºå®šåˆªé™¤ã€Œ' + name + 'ã€åˆ†é¡ï¼Ÿ')) return;

            showLoading('åˆªé™¤åˆ†é¡...');
            try {
                var result = await apiCall('deleteCategory', { category: name });
                if (result.success) {
                    showNotification('âœ… åˆ†é¡å·²åˆªé™¤', 'success');
                    await loadCategories();
                    renderCategoryList();
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                showNotification('åˆªé™¤å¤±æ•—: ' + err.message, 'error');
            }
            hideLoading();
        }

        // ===== é¡¯ç¤º/éš±è—è¼‰å…¥ä¸­ =====
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'è¼‰å…¥ä¸­...';
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function reloadApp() {
            showNotification('ğŸ”„ é‡æ–°æ•´ç†ä¸­...');
            setTimeout(function() { location.reload(); }, 300);
        }

        // ===== æª”æ¡ˆè¼¸å…¥ =====
        function initFileInputs() {
            document.getElementById('cardFrontCameraInput').addEventListener('change', function(e) { handleCardImage(e, 'front'); });
            document.getElementById('cardFrontGalleryInput').addEventListener('change', function(e) { handleCardImage(e, 'front'); });
            document.getElementById('cardBackCameraInput').addEventListener('change', function(e) { handleCardImage(e, 'back'); });
            document.getElementById('cardBackGalleryInput').addEventListener('change', function(e) { handleCardImage(e, 'back'); });
            document.getElementById('avatarCameraInput').addEventListener('change', handleAvatarImage);
            document.getElementById('avatarGalleryInput').addEventListener('change', handleAvatarImage);
        }

        function compressImage(file, maxWidth, quality, callback) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var ratio = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleCardImage(e, side) {
            var file = e.target.files[0];
            if (!file) return;

            compressImage(file, 1200, 0.8, function(dataUrl) {
                var box = document.getElementById(side === 'front' ? 'cardFrontBox' : 'cardBackBox');
                if (side === 'front') {
                    cardFrontImage = dataUrl;
                    cardFrontUrl = '';
                    document.getElementById('recognizeBtn').disabled = false;
                } else {
                    cardBackImage = dataUrl;
                    cardBackUrl = '';
                }
                box.innerHTML = '<img src="' + dataUrl + '" alt="åç‰‡">';
                box.classList.add('has-image');
            });
        }

        function handleAvatarImage(e) {
            var file = e.target.files[0];
            if (!file) return;

            compressImage(file, 400, 0.8, function(dataUrl) {
                avatarImage = dataUrl;
                avatarUrl = '';
                var preview = document.getElementById('avatarPreview');
                preview.style.backgroundImage = 'url("' + dataUrl + '")';
                preview.classList.add('has-image');
                preview.textContent = '';
            });
        }

        function captureCard(side) { document.getElementById(side === 'front' ? 'cardFrontCameraInput' : 'cardBackCameraInput').click(); }
        function selectCard(side) { document.getElementById(side === 'front' ? 'cardFrontGalleryInput' : 'cardBackGalleryInput').click(); }
        function captureAvatar() { document.getElementById('avatarCameraInput').click(); }
        function selectAvatar() { document.getElementById('avatarGalleryInput').click(); }

        // ===== é€šçŸ¥ =====
        function showNotification(msg, type) {
            var el = document.getElementById('notification');
            el.textContent = msg;
            el.className = 'notification active';
            if (type === 'error') el.classList.add('error');
            if (type === 'success') el.classList.add('success');
            setTimeout(function() { el.className = 'notification'; }, 3000);
        }

        // ===== æœ¬åœ°å„²å­˜ =====
        function loadFromLocal() {
            try {
                var saved = localStorage.getItem('businessCards_v6');
                if (saved) {
                    cards = JSON.parse(saved);
                }
            } catch (e) {
                cards = [];
            }
        }

        function saveToLocal() {
            try {
                localStorage.setItem('businessCards_v6', JSON.stringify(cards));
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }

        // ===== API å‘¼å« =====
        async function apiCall(action, data) {
            var body = Object.assign({ action: action }, data);
            var response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(body)
            });
            return await response.json();
        }

        async function apiGet() {
            var response = await fetch(API_URL);
            return await response.json();
        }

        // ===== é›²ç«¯åŒæ­¥ =====
        async function syncFromCloud() {
            var dot = document.getElementById('syncDot');
            var text = document.getElementById('syncText');
            dot.className = 'sync-dot syncing';
            text.textContent = 'åŒæ­¥ä¸­...';

            try {
                var result = await apiGet();
                if (result.success && result.data) {
                    var str = function(val) { return val === null || val === undefined ? '' : String(val); };
                    cards = result.data.map(function(row) {
                        return {
                            id: str(row['ID']) || String(Date.now()),
                            name: str(row['å§“å']),
                            nameEn: str(row['è‹±æ–‡å']),
                            company: str(row['å…¬å¸']),
                            title: str(row['è·ç¨±']),
                            phone: str(row['é›»è©±']),
                            email: str(row['Email']),
                            lineId: str(row['LINE_ID']),
                            category: str(row['åˆ†é¡']) || 'å…¶ä»–',
                            address: str(row['åœ°å€']),
                            website: str(row['ç¶²ç«™']),
                            notes: str(row['å‚™è¨»']),
                            cardFrontUrl: str(row['åç‰‡æ­£é¢']),
                            cardBackUrl: str(row['åç‰‡èƒŒé¢']),
                            avatarUrl: str(row['å¤§é ­ç…§'])
                        };
                    });
                    saveToLocal();
                    renderCards();
                    showNotification('âœ… åŒæ­¥æˆåŠŸï¼' + cards.length + ' ç­†', 'success');
                    dot.className = 'sync-dot online';
                    text.textContent = 'å·²é€£ç·š';
                } else {
                    throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
                }
            } catch (err) {
                console.error('åŒæ­¥éŒ¯èª¤:', err);
                showNotification('åŒæ­¥å¤±æ•—: ' + err.message, 'error');
                dot.className = 'sync-dot';
                text.textContent = 'é›¢ç·š';
                renderCards();
            }
        }

        async function uploadImageToDrive(base64Data, fileName) {
            if (!base64Data) return '';
            try {
                var base64Content = base64Data.split(',')[1];
                var mimeType = base64Data.match(/data:(.*?);/)[1];
                var result = await apiCall('uploadImage', {
                    fileName: fileName,
                    base64Data: base64Content,
                    mimeType: mimeType
                });
                return result.success ? result.url : '';
            } catch (err) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', err);
                return '';
            }
        }

        // è½‰æ› Google Drive URL ç‚ºå¯é¡¯ç¤ºçš„æ ¼å¼
        function getDriveImageUrl(url) {
            if (!url) return '';
            // å¦‚æœæ˜¯ drive.google.com/uc?id=xxx æ ¼å¼
            var match = url.match(/[?&]id=([^&]+)/);
            if (match) {
                return 'https://lh3.googleusercontent.com/d/' + match[1];
            }
            // å¦‚æœæ˜¯ drive.google.com/file/d/xxx æ ¼å¼
            match = url.match(/\/d\/([^\/]+)/);
            if (match) {
                return 'https://lh3.googleusercontent.com/d/' + match[1];
            }
            return url;
        }

        // ===== æ¸²æŸ“åç‰‡ =====
        function renderCards() {
            var grid = document.getElementById('cardsGrid');
            var search = document.getElementById('searchInput').value.toLowerCase();
            
            var filtered = cards.filter(function(card) {
                var matchSearch = !search || 
                    (card.name && card.name.toLowerCase().includes(search)) ||
                    (card.nameEn && card.nameEn.toLowerCase().includes(search)) ||
                    (card.company && card.company.toLowerCase().includes(search)) ||
                    (card.lineId && card.lineId.toLowerCase().includes(search)) ||
                    (card.notes && card.notes.toLowerCase().includes(search));
                var matchCat = currentCategory === 'å…¨éƒ¨' || card.category === currentCategory;
                return matchSearch && matchCat;
            });

            document.getElementById('totalCount').textContent = cards.length;
            document.getElementById('lineCount').textContent = cards.filter(function(c) { return c.lineId; }).length;
            document.getElementById('filterCount').textContent = filtered.length;

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">ğŸ“­</div><h3>' + 
                    (cards.length === 0 ? 'é‚„æ²’æœ‰åç‰‡' : 'æ‰¾ä¸åˆ°ç¬¦åˆçš„åç‰‡') + '</h3></div>';
                return;
            }

            grid.innerHTML = filtered.map(function(card) {
                var avatarImg = getDriveImageUrl(card.avatarUrl);
                var frontImg = getDriveImageUrl(card.cardFrontUrl);
                var backImg = getDriveImageUrl(card.cardBackUrl);
                var avatarStyle = avatarImg ? 'background-image:url("' + avatarImg + '");' : '';
                var hasImages = frontImg || backImg;
                
                return '<div class="card" onclick="openDetailModal(\'' + card.id + '\')">' +
                    '<span class="card-category">' + escapeHtml(card.category || 'å…¶ä»–') + '</span>' +
                    '<div class="card-header">' +
                        '<div class="card-avatar" style="' + avatarStyle + '">' + (avatarImg ? '' : (card.name ? card.name.charAt(0) : '?')) + '</div>' +
                        '<div>' +
                            '<div class="card-name">' + escapeHtml(card.name) + '</div>' +
                            (card.nameEn ? '<div class="card-name-en">' + escapeHtml(card.nameEn) + '</div>' : '') +
                            '<div class="card-title">' + (escapeHtml(card.title) || 'â€”') + '</div>' +
                        '</div>' +
                    '</div>' +
                    (card.company ? '<div class="card-company">ğŸ¢ ' + escapeHtml(card.company) + '</div>' : '') +
                    '<div class="card-contacts">' +
                        (card.phone ? '<div class="card-contact">ğŸ“± ' + escapeHtml(card.phone) + '</div>' : '') +
                        (card.lineId ? '<div class="card-contact card-line">ğŸ’¬ ' + escapeHtml(card.lineId) + '</div>' : '') +
                    '</div>' +
                    (hasImages ? '<div class="card-images">' +
                        (frontImg ? '<div class="card-image-thumb" style="background-image:url(\'' + frontImg + '\')"></div>' : '') +
                        (backImg ? '<div class="card-image-thumb" style="background-image:url(\'' + backImg + '\')"></div>' : '') +
                    '</div>' : '') +
                '</div>';
            }).join('');
        }

        function filterCards() { renderCards(); }

        function selectCategory(btn) {
            document.querySelectorAll('.category-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentCategory = btn.dataset.cat;
            renderCards();
        }

        // ===== Modal =====
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'â• æ–°å¢åç‰‡';
            clearForm();
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function clearForm() {
            document.getElementById('cardName').value = '';
            document.getElementById('cardNameEn').value = '';
            document.getElementById('cardCompany').value = '';
            document.getElementById('cardTitle').value = '';
            document.getElementById('cardPhone').value = '';
            document.getElementById('cardEmail').value = '';
            document.getElementById('cardLine').value = '';
            document.getElementById('cardCategory').value = categories[0] || 'å®¢æˆ¶';
            document.getElementById('cardAddress').value = '';
            document.getElementById('cardWebsite').value = '';
            document.getElementById('cardNotes').value = '';
            
            cardFrontImage = null;
            cardBackImage = null;
            avatarImage = null;
            cardFrontUrl = '';
            cardBackUrl = '';
            avatarUrl = '';
            ocrLines = [];
            
            document.getElementById('cardFrontBox').innerHTML = '<span class="image-box-icon">ğŸ“„</span><span class="image-box-label">æ­£é¢</span>';
            document.getElementById('cardFrontBox').classList.remove('has-image');
            document.getElementById('cardBackBox').innerHTML = '<span class="image-box-icon">ğŸ“„</span><span class="image-box-label">èƒŒé¢</span>';
            document.getElementById('cardBackBox').classList.remove('has-image');
            document.getElementById('avatarPreview').style.backgroundImage = '';
            document.getElementById('avatarPreview').classList.remove('has-image');
            document.getElementById('avatarPreview').textContent = 'ğŸ‘¤';
            document.getElementById('recognizeBtn').disabled = true;
            document.getElementById('ocrResult').classList.remove('active');
        }

        // ===== å„²å­˜åç‰‡ =====
        async function saveCard() {
            var name = document.getElementById('cardName').value.trim();
            if (!name) {
                showNotification('è«‹è¼¸å…¥å§“å', 'error');
                return;
            }

            var saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading"></span>';
            showLoading('å„²å­˜ä¸­...');

            try {
                var uploadedFrontUrl = cardFrontUrl;
                var uploadedBackUrl = cardBackUrl;
                var uploadedAvatarUrl = avatarUrl;

                if (cardFrontImage && !cardFrontUrl) {
                    showLoading('ä¸Šå‚³åç‰‡æ­£é¢...');
                    uploadedFrontUrl = await uploadImageToDrive(cardFrontImage, 'front_' + Date.now() + '.jpg');
                }
                if (cardBackImage && !cardBackUrl) {
                    showLoading('ä¸Šå‚³åç‰‡èƒŒé¢...');
                    uploadedBackUrl = await uploadImageToDrive(cardBackImage, 'back_' + Date.now() + '.jpg');
                }
                if (avatarImage && !avatarUrl) {
                    showLoading('ä¸Šå‚³å¤§é ­ç…§...');
                    uploadedAvatarUrl = await uploadImageToDrive(avatarImage, 'avatar_' + Date.now() + '.jpg');
                }

                var cardData = {
                    'ID': editingId || String(Date.now()),
                    'å§“å': name,
                    'è‹±æ–‡å': document.getElementById('cardNameEn').value.trim(),
                    'å…¬å¸': document.getElementById('cardCompany').value.trim(),
                    'è·ç¨±': document.getElementById('cardTitle').value.trim(),
                    'é›»è©±': document.getElementById('cardPhone').value.trim(),
                    'Email': document.getElementById('cardEmail').value.trim(),
                    'LINE_ID': document.getElementById('cardLine').value.trim(),
                    'åˆ†é¡': document.getElementById('cardCategory').value,
                    'åœ°å€': document.getElementById('cardAddress').value.trim(),
                    'ç¶²ç«™': document.getElementById('cardWebsite').value.trim(),
                    'å‚™è¨»': document.getElementById('cardNotes').value.trim(),
                    'åç‰‡æ­£é¢': uploadedFrontUrl,
                    'åç‰‡èƒŒé¢': uploadedBackUrl,
                    'å¤§é ­ç…§': uploadedAvatarUrl
                };

                showLoading('å„²å­˜åˆ°é›²ç«¯...');
                var action = editingId ? 'update' : 'add';
                var result = await apiCall(action, { card: cardData });

                if (result.success) {
                    showNotification('âœ… ' + result.message, 'success');
                    closeAddModal();
                    await syncFromCloud();
                } else {
                    throw new Error(result.error || 'å„²å­˜å¤±æ•—');
                }
            } catch (err) {
                showNotification('å„²å­˜å¤±æ•—: ' + err.message, 'error');
            }

            hideLoading();
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'ğŸ’¾ å„²å­˜';
        }

        // ===== è©³ç´°é  =====
        function openDetailModal(id) {
            var card = cards.find(function(c) { return c.id === id; });
            if (!card) return;

            var avatarImg = getDriveImageUrl(card.avatarUrl);
            var frontImg = getDriveImageUrl(card.cardFrontUrl);
            var backImg = getDriveImageUrl(card.cardBackUrl);
            var avatarStyle = avatarImg ? 'background-image:url("' + avatarImg + '");' : '';
            var hasImages = frontImg || backImg;
            
            var imagesHtml = '';
            if (hasImages) {
                imagesHtml = '<div class="detail-images">';
                if (frontImg) imagesHtml += '<div class="detail-image"><img src="' + frontImg + '" alt="æ­£é¢"><div class="detail-image-label">æ­£é¢</div></div>';
                if (backImg) imagesHtml += '<div class="detail-image"><img src="' + backImg + '" alt="èƒŒé¢"><div class="detail-image-label">èƒŒé¢</div></div>';
                imagesHtml += '</div>';
            }

            document.getElementById('detailContent').innerHTML = 
                imagesHtml +
                '<div class="detail-header">' +
                    '<div class="detail-avatar" style="' + avatarStyle + '">' + (avatarImg ? '' : card.name.charAt(0)) + '</div>' +
                    '<div class="detail-info">' +
                        '<h2>' + escapeHtml(card.name) + '</h2>' +
                        (card.nameEn ? '<div class="name-en">' + escapeHtml(card.nameEn) + '</div>' : '') +
                        '<p>' + (escapeHtml(card.title) || 'â€”') + '</p>' +
                        '<span class="detail-category">' + escapeHtml(card.category || 'å…¶ä»–') + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="detail-section">' +
                    (card.company ? '<div class="detail-row"><span class="detail-row-icon">ğŸ¢</span><span class="detail-row-label">å…¬å¸</span><span class="detail-row-value">' + escapeHtml(card.company) + '</span></div>' : '') +
                    (card.phone ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“±</span><span class="detail-row-label">é›»è©±</span><span class="detail-row-value"><a href="tel:' + card.phone + '">' + escapeHtml(card.phone) + '</a></span></div>' : '') +
                    (card.lineId ? '<div class="detail-row"><span class="detail-row-icon">ğŸ’¬</span><span class="detail-row-label">LINE</span><span class="detail-row-value line"><a href="https://line.me/ti/p/~' + card.lineId + '" target="_blank">' + escapeHtml(card.lineId) + '</a></span></div>' : '') +
                    (card.email ? '<div class="detail-row"><span class="detail-row-icon">âœ‰ï¸</span><span class="detail-row-label">Email</span><span class="detail-row-value"><a href="mailto:' + card.email + '">' + escapeHtml(card.email) + '</a></span></div>' : '') +
                    (card.address ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“</span><span class="detail-row-label">åœ°å€</span><span class="detail-row-value">' + escapeHtml(card.address) + '</span></div>' : '') +
                    (card.website ? '<div class="detail-row"><span class="detail-row-icon">ğŸŒ</span><span class="detail-row-label">ç¶²ç«™</span><span class="detail-row-value"><a href="' + (card.website.startsWith('http') ? card.website : 'https://' + card.website) + '" target="_blank">' + escapeHtml(card.website) + '</a></span></div>' : '') +
                '</div>' +
                (card.notes ? '<div class="detail-notes"><h4>ğŸ“ å‚™è¨»</h4><p>' + escapeHtml(card.notes) + '</p></div>' : '') +
                '<div class="form-actions">' +
                    '<button class="btn btn-danger" onclick="deleteCard(\'' + card.id + '\')">ğŸ—‘ï¸ åˆªé™¤</button>' +
                    '<button class="btn btn-primary" onclick="openEditModal(\'' + card.id + '\')">âœï¸ ç·¨è¼¯</button>' +
                '</div>';

            document.getElementById('detailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function openEditModal(id) {
            var card = cards.find(function(c) { return c.id === id; });
            if (!card) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'âœï¸ ç·¨è¼¯åç‰‡';
            
            document.getElementById('cardName').value = card.name || '';
            document.getElementById('cardNameEn').value = card.nameEn || '';
            document.getElementById('cardCompany').value = card.company || '';
            document.getElementById('cardTitle').value = card.title || '';
            document.getElementById('cardPhone').value = card.phone || '';
            document.getElementById('cardEmail').value = card.email || '';
            document.getElementById('cardLine').value = card.lineId || '';
            document.getElementById('cardCategory').value = card.category || categories[0];
            document.getElementById('cardAddress').value = card.address || '';
            document.getElementById('cardWebsite').value = card.website || '';
            document.getElementById('cardNotes').value = card.notes || '';

            cardFrontUrl = card.cardFrontUrl || '';
            cardBackUrl = card.cardBackUrl || '';
            avatarUrl = card.avatarUrl || '';
            cardFrontImage = null;
            cardBackImage = null;
            avatarImage = null;

            if (cardFrontUrl) {
                document.getElementById('cardFrontBox').innerHTML = '<img src="' + getDriveImageUrl(cardFrontUrl) + '" alt="æ­£é¢">';
                document.getElementById('cardFrontBox').classList.add('has-image');
            }
            if (cardBackUrl) {
                document.getElementById('cardBackBox').innerHTML = '<img src="' + getDriveImageUrl(cardBackUrl) + '" alt="èƒŒé¢">';
                document.getElementById('cardBackBox').classList.add('has-image');
            }
            if (avatarUrl) {
                document.getElementById('avatarPreview').style.backgroundImage = 'url("' + getDriveImageUrl(avatarUrl) + '")';
                document.getElementById('avatarPreview').classList.add('has-image');
                document.getElementById('avatarPreview').textContent = '';
            }

            document.getElementById('ocrResult').classList.remove('active');
            closeDetailModal();
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function deleteCard(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™å¼µåç‰‡ï¼Ÿ')) return;
            showLoading('åˆªé™¤ä¸­...');
            try {
                var result = await apiCall('delete', { id: id });
                if (result.success) {
                    showNotification('ğŸ—‘ï¸ å·²åˆªé™¤', 'success');
                    closeDetailModal();
                    await syncFromCloud();
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                showNotification('åˆªé™¤å¤±æ•—: ' + err.message, 'error');
            }
            hideLoading();
        }

        // ===== OCR è¾¨è­˜ =====
        async function recognizeCard() {
            if (!cardFrontImage) return;

            var btn = document.getElementById('recognizeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';
            showLoading('è¾¨è­˜ä¸­...');

            try {
                var base64Content = cardFrontImage.split(',')[1];
                var result = await apiCall('ocr', { base64Image: base64Content });

                if (result.success && result.text) {
                    ocrLines = result.text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
                    renderOcrLines();
                    document.getElementById('ocrResult').classList.add('active');
                    showNotification('âœ… è¾¨è­˜å®Œæˆï¼Œè«‹é»æ“ŠæŒ‰éˆ•å¡«å…¥æ¬„ä½', 'success');
                } else {
                    throw new Error(result.error || 'ç„¡æ³•è¾¨è­˜');
                }
            } catch (err) {
                showNotification('è¾¨è­˜å¤±æ•—: ' + err.message, 'error');
            }

            hideLoading();
            btn.disabled = false;
            btn.innerHTML = 'ğŸ” è¾¨è­˜';
        }

        function renderOcrLines() {
            var container = document.getElementById('ocrLines');
            container.innerHTML = ocrLines.map(function(line, index) {
                return '<div class="ocr-line">' +
                    '<span class="ocr-line-text">' + escapeHtml(line) + '</span>' +
                    '<div class="ocr-line-btns">' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardName\', ' + index + ', this)">å§“å</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardNameEn\', ' + index + ', this)">è‹±æ–‡</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardCompany\', ' + index + ', this)">å…¬å¸</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardTitle\', ' + index + ', this)">è·ç¨±</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardPhone\', ' + index + ', this)">é›»è©±</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardEmail\', ' + index + ', this)">Email</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardLine\', ' + index + ', this)">LINE</button>' +
                        '<button class="ocr-field-btn" onclick="fillField(\'cardAddress\', ' + index + ', this)">åœ°å€</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function fillField(fieldId, lineIndex, btnEl) {
            var value = ocrLines[lineIndex];
            document.getElementById(fieldId).value = value;
            
            // æ¨™è¨˜å·²ä½¿ç”¨
            btnEl.classList.add('used');
            
            // é–ƒçˆæ•ˆæœ
            var input = document.getElementById(fieldId);
            input.style.backgroundColor = 'rgba(6, 214, 160, 0.3)';
            setTimeout(function() {
                input.style.backgroundColor = '';
            }, 500);

            showNotification('å·²å¡«å…¥: ' + value.substring(0, 20) + (value.length > 20 ? '...' : ''));
        }

        // ===== å·¥å…· =====
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // ===== äº‹ä»¶ =====
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddModal();
                closeDetailModal();
                closeCategoryModal();
            }
        });

        document.getElementById('addModal').addEventListener('click', function(e) { if (e.target === this) closeAddModal(); });
        document.getElementById('detailModal').addEventListener('click', function(e) { if (e.target === this) closeDetailModal(); });
        document.getElementById('categoryModal').addEventListener('click', function(e) { if (e.target === this) closeCategoryModal(); });
    </script>
</body>
</html>
