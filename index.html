<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åç‰‡ç®¡ç†ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #06d6a0;
            --primary-dark: #00b890;
            --accent: #3b82f6;
            --bg-dark: #0f172a;
            --bg-card: rgba(255,255,255,0.06);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255,255,255,0.1);
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(6, 214, 160, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        .header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 20px rgba(6, 214, 160, 0.3);
        }

        .logo-text h1 { font-size: 20px; font-weight: 700; }
        .logo-text p { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .search-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box input:focus { border-color: var(--primary); }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        .categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.08);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: transparent;
            font-weight: 600;
        }

        .main {
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-value.primary { color: var(--primary); }
        .stat-value.accent { color: var(--accent); }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-color: rgba(6, 214, 160, 0.3);
        }

        .card-category {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }

        .card-avatar {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            background-size: cover;
            background-position: center;
        }

        .card-name { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
        .card-title { font-size: 13px; color: var(--text-secondary); }
        .card-company { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; }
        .card-contacts { display: flex; flex-direction: column; gap: 8px; }
        .card-contact { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }

        .card-line {
            background: rgba(6, 214, 160, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(6, 214, 160, 0.2);
            color: var(--primary);
            font-weight: 500;
        }

        .card-notes {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.04);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-muted);
            border-left: 3px solid var(--border);
        }

        .card-image-thumb {
            width: 100%;
            height: 80px;
            margin-top: 12px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border);
        }

        /* åˆ†é¡é¡è‰² */
        .cat-å®¢æˆ¶ { background: #fef3c7; color: #92400e; }
        .cat-ä¾›æ‡‰å•† { background: #dbeafe; color: #1e40af; }
        .cat-åˆä½œå¤¥ä¼´ { background: #dcfce7; color: #166534; }
        .cat-åŒäº‹ { background: #fae8ff; color: #86198f; }
        .cat-æœ‹å‹ { background: #ffedd5; color: #9a3412; }
        .cat-å…¶ä»– { background: #f1f5f9; color: #334155; }

        .avatar-å®¢æˆ¶ { background: linear-gradient(135deg, #f59e0b, #fef3c7); color: #92400e; }
        .avatar-ä¾›æ‡‰å•† { background: linear-gradient(135deg, #3b82f6, #dbeafe); color: #1e40af; }
        .avatar-åˆä½œå¤¥ä¼´ { background: linear-gradient(135deg, #22c55e, #dcfce7); color: #166534; }
        .avatar-åŒäº‹ { background: linear-gradient(135deg, #d946ef, #fae8ff); color: #86198f; }
        .avatar-æœ‹å‹ { background: linear-gradient(135deg, #f97316, #ffedd5); color: #9a3412; }
        .avatar-å…¶ä»– { background: linear-gradient(135deg, #64748b, #f1f5f9); color: #334155; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 { font-size: 20px; font-weight: 700; }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
        }

        .form-group { margin-bottom: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }

        .form-input:focus { border-color: var(--primary); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input.highlight { background: rgba(6, 214, 160, 0.1); border-color: rgba(6, 214, 160, 0.3); }
        textarea.form-input { resize: vertical; min-height: 70px; }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .form-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 14px;
        }

        /* æ‹ç…§å€ */
        .camera-section {
            margin-bottom: 16px;
            padding: 14px;
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            border: 2px dashed var(--border);
        }

        .camera-preview {
            width: 100%;
            max-height: 180px;
            object-fit: contain;
            border-radius: 8px;
            display: none;
            margin-bottom: 12px;
        }

        .camera-preview.active { display: block; }

        .camera-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .camera-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            border-radius: 10px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }

        .camera-btn.capture { background: linear-gradient(135deg, var(--accent), #2563eb); color: white; }
        .camera-btn.recognize { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .camera-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #cameraInput, #avatarInput { display: none; }

        .ocr-result {
            margin-top: 12px;
            padding: 12px;
            background: rgba(6, 214, 160, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(6, 214, 160, 0.2);
            font-size: 12px;
            display: none;
        }

        .ocr-result.active { display: block; }
        .ocr-result h4 { color: var(--primary); margin-bottom: 8px; font-size: 13px; }
        .ocr-text { color: var(--text-secondary); line-height: 1.5; white-space: pre-wrap; max-height: 120px; overflow-y: auto; }

        /* å¤§é ­ç…§å€ */
        .avatar-section {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding: 14px;
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
        }

        .avatar-preview {
            width: 70px;
            height: 70px;
            border-radius: 14px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background-size: cover;
            background-position: center;
            border: 2px dashed var(--border);
            flex-shrink: 0;
        }

        .avatar-preview.has-image { border-style: solid; border-color: var(--primary); }
        .avatar-info { flex: 1; }
        .avatar-info h4 { font-size: 14px; margin-bottom: 4px; }
        .avatar-info p { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }

        .avatar-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
        }

        /* è©³ç´°é  */
        .detail-header { display: flex; gap: 14px; margin-bottom: 16px; }

        .detail-avatar {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: 700;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .detail-info h2 { font-size: 24px; margin-bottom: 4px; }
        .detail-info p { color: var(--text-secondary); font-size: 14px; }

        .detail-category {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 6px;
        }

        .detail-section {
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-row-icon { font-size: 16px; margin-right: 10px; }
        .detail-row-label { width: 60px; font-size: 12px; color: var(--text-muted); }
        .detail-row-value { flex: 1; font-size: 14px; }
        .detail-row-value a { color: var(--text-primary); text-decoration: none; }
        .detail-row-value a:hover { color: var(--primary); }
        .detail-row-value.line { color: var(--primary); font-weight: 500; }

        .detail-notes { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 14px; margin-bottom: 14px; }
        .detail-notes h4 { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .detail-notes p { font-size: 14px; line-height: 1.5; }

        .detail-card-image { width: 100%; border-radius: 12px; margin-bottom: 14px; border: 1px solid var(--border); }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 50px; margin-bottom: 14px; opacity: 0.5; }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--text-secondary); }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 300;
            transition: transform 0.3s;
            font-size: 14px;
        }

        .notification.active { transform: translateX(-50%) translateY(0); }
        .notification.error { background: var(--danger); }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .sync-status { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary); }
        .sync-dot.syncing { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        @media (max-width: 600px) {
            .header-top { flex-direction: column; align-items: stretch; }
            .header-actions { justify-content: center; }
            .form-row { grid-template-columns: 1fr; }
            .cards-grid { grid-template-columns: 1fr; }
            .avatar-section { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>

    <header class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-icon">ğŸ“‡</div>
                <div class="logo-text">
                    <h1>åç‰‡ç®¡ç†ä¸­å¿ƒ</h1>
                    <p>ğŸ“· æ‹ç…§è¾¨è­˜ Â· ğŸ’¬ LINE æ•´åˆ Â· â˜ï¸ é›²ç«¯åŒæ­¥</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="sync-status">
                    <span class="sync-dot" id="syncDot"></span>
                    <span id="syncText">æœ¬åœ°</span>
                </div>
                <button class="btn btn-secondary" onclick="syncFromSheet()">ğŸ”„ åŒæ­¥</button>
                <button class="btn btn-primary" onclick="openAddModal()">â• æ–°å¢</button>
            </div>
        </div>
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœå°‹å§“åã€å…¬å¸ã€LINE ID..." oninput="filterCards()">
            </div>
            <div class="categories" id="categories"></div>
        </div>
    </header>

    <main class="main">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š ç¸½åç‰‡</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¬ æœ‰LINE</div>
                <div class="stat-value primary" id="lineCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ” çµæœ</div>
                <div class="stat-value accent" id="filterCount">0</div>
            </div>
        </div>
        <div class="cards-grid" id="cardsGrid"></div>
    </main>

    <!-- æ–°å¢ Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">â• æ–°å¢åç‰‡</h2>
                <button class="modal-close" onclick="closeAddModal()">âœ•</button>
            </div>

            <div class="camera-section">
                <img id="cameraPreview" class="camera-preview" alt="åç‰‡">
                <input type="file" id="cameraInput" accept="image/*" capture="environment">
                <div class="camera-btns">
                    <button type="button" class="camera-btn capture" onclick="document.getElementById('cameraInput').click()">ğŸ“· æ‹åç‰‡</button>
                    <button type="button" class="camera-btn recognize" id="recognizeBtn" onclick="recognizeCard()" disabled>ğŸ” è¾¨è­˜</button>
                </div>
                <div class="ocr-result" id="ocrResult">
                    <h4>ğŸ“ è¾¨è­˜çµæœ</h4>
                    <div class="ocr-text" id="ocrText"></div>
                </div>
            </div>

            <div class="avatar-section">
                <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                <input type="file" id="avatarInput" accept="image/*">
                <div class="avatar-info">
                    <h4>ğŸ“¸ å¤§é ­ç…§</h4>
                    <p>ä¸Šå‚³è¯çµ¡äººç…§ç‰‡</p>
                    <button type="button" class="avatar-btn" onclick="document.getElementById('avatarInput').click()">é¸æ“‡ç…§ç‰‡</button>
                </div>
            </div>

            <div id="cardForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ å§“å *</label>
                        <input type="text" class="form-input" id="cardName" placeholder="ç‹å¤§æ˜">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“ åˆ†é¡</label>
                        <select class="form-input" id="cardCategory">
                            <option value="å®¢æˆ¶">å®¢æˆ¶</option>
                            <option value="ä¾›æ‡‰å•†">ä¾›æ‡‰å•†</option>
                            <option value="åˆä½œå¤¥ä¼´">åˆä½œå¤¥ä¼´</option>
                            <option value="åŒäº‹">åŒäº‹</option>
                            <option value="æœ‹å‹">æœ‹å‹</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ¢ å…¬å¸</label>
                    <input type="text" class="form-input" id="cardCompany" placeholder="å°ç£ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ’¼ è·ç¨±</label>
                    <input type="text" class="form-input" id="cardTitle" placeholder="æ¥­å‹™ç¶“ç†">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ğŸ“± é›»è©±</label>
                        <input type="tel" class="form-input" id="cardPhone" placeholder="0912-345-678">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ’¬ LINE ID</label>
                        <input type="text" class="form-input highlight" id="cardLine" placeholder="line_id">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ğŸ“  å‚³çœŸ</label>
                        <input type="tel" class="form-input" id="cardFax" placeholder="02-1234-5678">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“± æ‰‹æ©Ÿ2</label>
                        <input type="tel" class="form-input" id="cardMobile2" placeholder="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">âœ‰ï¸ Email</label>
                    <input type="email" class="form-input" id="cardEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ åœ°å€</label>
                    <input type="text" class="form-input" id="cardAddress" placeholder="å°åŒ—å¸‚...">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸŒ ç¶²ç«™</label>
                    <input type="text" class="form-input" id="cardWebsite" placeholder="www.example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ å‚™è¨»</label>
                    <textarea class="form-input" id="cardNotes" placeholder="å‚™è¨»..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveCard()">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´° Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ“‡ åç‰‡è©³æƒ…</h2>
                <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const CONFIG = {
            VISION_API_KEY: 'AIzaSyDLVs8BwB5Uy0EWl0HSjAwXKxVml1bAv_Y',
            SHEET_ID: '1WcV71Rh8T5uxgce-Nuh5XuO8Fn1Mn1GGLp8cYpmY1oo'
        };

        // åˆ†é¡
        const CATEGORIES = ['å…¨éƒ¨', 'å®¢æˆ¶', 'ä¾›æ‡‰å•†', 'åˆä½œå¤¥ä¼´', 'åŒäº‹', 'æœ‹å‹', 'å…¶ä»–'];

        // å…¨åŸŸè®Šæ•¸
        let cards = [];
        let currentCategory = 'å…¨éƒ¨';
        let currentImage = null;
        let currentAvatar = null;
        let editingId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App åˆå§‹åŒ–...');
            initCategories();
            initFileInputs();
            loadFromLocal();
            renderCards();
            // å˜—è©¦åŒæ­¥
            setTimeout(syncFromSheet, 1000);
        });

        // åˆå§‹åŒ–åˆ†é¡æŒ‰éˆ•
        function initCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = CATEGORIES.map(cat => 
                `<button class="category-btn ${cat === 'å…¨éƒ¨' ? 'active' : ''}" data-cat="${cat}" onclick="selectCategory(this)">${cat}</button>`
            ).join('');
        }

        // åˆå§‹åŒ–æª”æ¡ˆè¼¸å…¥
        function initFileInputs() {
            document.getElementById('cameraInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    currentImage = evt.target.result;
                    document.getElementById('cameraPreview').src = currentImage;
                    document.getElementById('cameraPreview').classList.add('active');
                    document.getElementById('recognizeBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('avatarInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    currentAvatar = evt.target.result;
                    const preview = document.getElementById('avatarPreview');
                    preview.style.backgroundImage = `url('${currentAvatar}')`;
                    preview.classList.add('has-image');
                    preview.textContent = '';
                };
                reader.readAsDataURL(file);
            });
        }

        // é€šçŸ¥
        function showNotification(msg, isError) {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.className = 'notification active' + (isError ? ' error' : '');
            setTimeout(function() { el.className = 'notification'; }, 3000);
        }

        // æœ¬åœ°å„²å­˜
        function loadFromLocal() {
            try {
                const saved = localStorage.getItem('businessCards_v3');
                if (saved) {
                    cards = JSON.parse(saved);
                    console.log('è¼‰å…¥æœ¬åœ°è³‡æ–™:', cards.length, 'ç­†');
                }
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
                cards = [];
            }
        }

        function saveToLocal() {
            try {
                localStorage.setItem('businessCards_v3', JSON.stringify(cards));
                console.log('å·²å„²å­˜åˆ°æœ¬åœ°:', cards.length, 'ç­†');
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }

        // Google Sheets åŒæ­¥
        async function syncFromSheet() {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            dot.classList.add('syncing');
            text.textContent = 'åŒæ­¥ä¸­...';

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/A:O?key=${CONFIG.VISION_API_KEY}`;
                console.log('åŒæ­¥ URL:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                console.log('åŒæ­¥çµæœ:', data);

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.values && data.values.length > 1) {
                    const newCards = data.values.slice(1).map(function(row, i) {
                        return {
                            id: row[0] || String(Date.now() + i),
                            name: row[1] || '',
                            company: row[2] || '',
                            title: row[3] || '',
                            phone: row[4] || '',
                            email: row[5] || '',
                            lineId: row[6] || '',
                            category: row[7] || 'å…¶ä»–',
                            address: row[8] || '',
                            website: row[9] || '',
                            notes: row[10] || '',
                            fax: row[11] || '',
                            mobile2: row[12] || '',
                            cardImage: row[13] || '',
                            avatar: row[14] || ''
                        };
                    }).filter(function(c) { return c.name; });

                    if (newCards.length > 0) {
                        cards = newCards;
                        saveToLocal();
                        renderCards();
                        showNotification('âœ… åŒæ­¥æˆåŠŸï¼' + newCards.length + ' ç­†');
                    }
                } else {
                    showNotification('è©¦ç®—è¡¨æ²’æœ‰è³‡æ–™');
                }
            } catch (err) {
                console.error('åŒæ­¥éŒ¯èª¤:', err);
                showNotification('åŒæ­¥å¤±æ•—: ' + err.message, true);
            }

            dot.classList.remove('syncing');
            text.textContent = 'æœ¬åœ°';
        }

        // æ¸²æŸ“åç‰‡
        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = cards.filter(function(card) {
                const matchSearch = !search || 
                    (card.name && card.name.toLowerCase().includes(search)) ||
                    (card.company && card.company.toLowerCase().includes(search)) ||
                    (card.lineId && card.lineId.toLowerCase().includes(search)) ||
                    (card.notes && card.notes.toLowerCase().includes(search));
                const matchCat = currentCategory === 'å…¨éƒ¨' || card.category === currentCategory;
                return matchSearch && matchCat;
            });

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('totalCount').textContent = cards.length;
            document.getElementById('lineCount').textContent = cards.filter(function(c) { return c.lineId; }).length;
            document.getElementById('filterCount').textContent = filtered.length;

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">ğŸ“­</div><h3>' + 
                    (cards.length === 0 ? 'é‚„æ²’æœ‰åç‰‡' : 'æ‰¾ä¸åˆ°ç¬¦åˆçš„åç‰‡') + '</h3></div>';
                return;
            }

            grid.innerHTML = filtered.map(function(card) {
                const avatarStyle = card.avatar ? 'background-image:url(\'' + card.avatar + '\');color:transparent;' : '';
                return '<div class="card" onclick="openDetailModal(\'' + card.id + '\')">' +
                    '<span class="card-category cat-' + card.category + '">' + card.category + '</span>' +
                    '<div class="card-header">' +
                        '<div class="card-avatar avatar-' + card.category + '" style="' + avatarStyle + '">' + (card.avatar ? '' : card.name.charAt(0)) + '</div>' +
                        '<div><div class="card-name">' + escapeHtml(card.name) + '</div>' +
                        '<div class="card-title">' + (escapeHtml(card.title) || 'â€”') + '</div></div>' +
                    '</div>' +
                    (card.company ? '<div class="card-company">ğŸ¢ ' + escapeHtml(card.company) + '</div>' : '') +
                    '<div class="card-contacts">' +
                        (card.phone ? '<div class="card-contact">ğŸ“± ' + escapeHtml(card.phone) + '</div>' : '') +
                        (card.lineId ? '<div class="card-contact card-line">ğŸ’¬ LINE: ' + escapeHtml(card.lineId) + '</div>' : '') +
                    '</div>' +
                    (card.notes ? '<div class="card-notes">ğŸ“ ' + escapeHtml(card.notes.substring(0, 40)) + '</div>' : '') +
                    (card.cardImage ? '<div class="card-image-thumb" style="background-image:url(\'' + card.cardImage + '\')"></div>' : '') +
                '</div>';
            }).join('');
        }

        function filterCards() {
            renderCards();
        }

        function selectCategory(btn) {
            document.querySelectorAll('.category-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentCategory = btn.dataset.cat;
            renderCards();
        }

        // Modal æ“ä½œ
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'â• æ–°å¢åç‰‡';
            clearForm();
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function clearForm() {
            document.getElementById('cardName').value = '';
            document.getElementById('cardCompany').value = '';
            document.getElementById('cardTitle').value = '';
            document.getElementById('cardPhone').value = '';
            document.getElementById('cardEmail').value = '';
            document.getElementById('cardLine').value = '';
            document.getElementById('cardCategory').value = 'å®¢æˆ¶';
            document.getElementById('cardAddress').value = '';
            document.getElementById('cardWebsite').value = '';
            document.getElementById('cardNotes').value = '';
            document.getElementById('cardFax').value = '';
            document.getElementById('cardMobile2').value = '';
            document.getElementById('cameraPreview').classList.remove('active');
            document.getElementById('ocrResult').classList.remove('active');
            document.getElementById('recognizeBtn').disabled = true;
            document.getElementById('avatarPreview').style.backgroundImage = '';
            document.getElementById('avatarPreview').classList.remove('has-image');
            document.getElementById('avatarPreview').textContent = 'ğŸ‘¤';
            currentImage = null;
            currentAvatar = null;
        }

        // å„²å­˜åç‰‡
        function saveCard() {
            const name = document.getElementById('cardName').value.trim();
            if (!name) {
                showNotification('è«‹è¼¸å…¥å§“å', true);
                return;
            }

            const card = {
                id: editingId || String(Date.now()),
                name: name,
                company: document.getElementById('cardCompany').value.trim(),
                title: document.getElementById('cardTitle').value.trim(),
                phone: document.getElementById('cardPhone').value.trim(),
                email: document.getElementById('cardEmail').value.trim(),
                lineId: document.getElementById('cardLine').value.trim(),
                category: document.getElementById('cardCategory').value,
                address: document.getElementById('cardAddress').value.trim(),
                website: document.getElementById('cardWebsite').value.trim(),
                notes: document.getElementById('cardNotes').value.trim(),
                fax: document.getElementById('cardFax').value.trim(),
                mobile2: document.getElementById('cardMobile2').value.trim(),
                cardImage: currentImage || '',
                avatar: currentAvatar || ''
            };

            console.log('å„²å­˜åç‰‡:', card);

            if (editingId) {
                const idx = cards.findIndex(function(c) { return c.id === editingId; });
                if (idx !== -1) cards[idx] = card;
                showNotification('âœ… å·²æ›´æ–°ï¼');
            } else {
                cards.unshift(card);
                showNotification('âœ… å·²æ–°å¢ï¼');
            }

            saveToLocal();
            renderCards();
            closeAddModal();

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            copyToClipboard(card);
        }

        function copyToClipboard(card) {
            const data = [card.id, card.name, card.company, card.title, card.phone, card.email, card.lineId, card.category, card.address, card.website, card.notes, card.fax, card.mobile2].join('\t');
            navigator.clipboard.writeText(data).then(function() {
                console.log('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch(function(e) {
                console.log('è¤‡è£½å¤±æ•—:', e);
            });
        }

        // è©³ç´°é 
        function openDetailModal(id) {
            const card = cards.find(function(c) { return c.id === id; });
            if (!card) return;

            const avatarStyle = card.avatar ? 'background-image:url(\'' + card.avatar + '\');color:transparent;' : '';
            
            document.getElementById('detailContent').innerHTML = 
                (card.cardImage ? '<img src="' + card.cardImage + '" class="detail-card-image">' : '') +
                '<div class="detail-header">' +
                    '<div class="detail-avatar avatar-' + card.category + '" style="' + avatarStyle + '">' + (card.avatar ? '' : card.name.charAt(0)) + '</div>' +
                    '<div class="detail-info"><h2>' + escapeHtml(card.name) + '</h2>' +
                    '<p>' + (escapeHtml(card.title) || 'â€”') + '</p>' +
                    '<span class="detail-category cat-' + card.category + '">' + card.category + '</span></div>' +
                '</div>' +
                '<div class="detail-section">' +
                    (card.company ? '<div class="detail-row"><span class="detail-row-icon">ğŸ¢</span><span class="detail-row-label">å…¬å¸</span><span class="detail-row-value">' + escapeHtml(card.company) + '</span></div>' : '') +
                    (card.phone ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“±</span><span class="detail-row-label">é›»è©±</span><span class="detail-row-value"><a href="tel:' + card.phone + '">' + escapeHtml(card.phone) + '</a></span></div>' : '') +
                    (card.mobile2 ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“±</span><span class="detail-row-label">æ‰‹æ©Ÿ2</span><span class="detail-row-value"><a href="tel:' + card.mobile2 + '">' + escapeHtml(card.mobile2) + '</a></span></div>' : '') +
                    (card.fax ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“ </span><span class="detail-row-label">å‚³çœŸ</span><span class="detail-row-value">' + escapeHtml(card.fax) + '</span></div>' : '') +
                    (card.lineId ? '<div class="detail-row"><span class="detail-row-icon">ğŸ’¬</span><span class="detail-row-label">LINE</span><span class="detail-row-value line"><a href="https://line.me/ti/p/~' + card.lineId + '" target="_blank">' + escapeHtml(card.lineId) + '</a></span></div>' : '') +
                    (card.email ? '<div class="detail-row"><span class="detail-row-icon">âœ‰ï¸</span><span class="detail-row-label">Email</span><span class="detail-row-value"><a href="mailto:' + card.email + '">' + escapeHtml(card.email) + '</a></span></div>' : '') +
                    (card.address ? '<div class="detail-row"><span class="detail-row-icon">ğŸ“</span><span class="detail-row-label">åœ°å€</span><span class="detail-row-value">' + escapeHtml(card.address) + '</span></div>' : '') +
                    (card.website ? '<div class="detail-row"><span class="detail-row-icon">ğŸŒ</span><span class="detail-row-label">ç¶²ç«™</span><span class="detail-row-value"><a href="' + (card.website.startsWith('http') ? card.website : 'https://' + card.website) + '" target="_blank">' + escapeHtml(card.website) + '</a></span></div>' : '') +
                '</div>' +
                (card.notes ? '<div class="detail-notes"><h4>ğŸ“ å‚™è¨»</h4><p>' + escapeHtml(card.notes) + '</p></div>' : '') +
                '<div class="form-actions">' +
                    '<button class="btn btn-danger" onclick="deleteCard(\'' + card.id + '\')">ğŸ—‘ï¸ åˆªé™¤</button>' +
                    '<button class="btn btn-primary" onclick="openEditModal(\'' + card.id + '\')">âœï¸ ç·¨è¼¯</button>' +
                '</div>';

            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function openEditModal(id) {
            const card = cards.find(function(c) { return c.id === id; });
            if (!card) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'âœï¸ ç·¨è¼¯åç‰‡';
            document.getElementById('cardName').value = card.name || '';
            document.getElementById('cardCompany').value = card.company || '';
            document.getElementById('cardTitle').value = card.title || '';
            document.getElementById('cardPhone').value = card.phone || '';
            document.getElementById('cardEmail').value = card.email || '';
            document.getElementById('cardLine').value = card.lineId || '';
            document.getElementById('cardCategory').value = card.category || 'å®¢æˆ¶';
            document.getElementById('cardAddress').value = card.address || '';
            document.getElementById('cardWebsite').value = card.website || '';
            document.getElementById('cardNotes').value = card.notes || '';
            document.getElementById('cardFax').value = card.fax || '';
            document.getElementById('cardMobile2').value = card.mobile2 || '';

            if (card.cardImage) {
                currentImage = card.cardImage;
                document.getElementById('cameraPreview').src = card.cardImage;
                document.getElementById('cameraPreview').classList.add('active');
            }

            if (card.avatar) {
                currentAvatar = card.avatar;
                document.getElementById('avatarPreview').style.backgroundImage = 'url(\'' + card.avatar + '\')';
                document.getElementById('avatarPreview').classList.add('has-image');
                document.getElementById('avatarPreview').textContent = '';
            }

            closeDetailModal();
            document.getElementById('addModal').classList.add('active');
        }

        function deleteCard(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            cards = cards.filter(function(c) { return c.id !== id; });
            saveToLocal();
            renderCards();
            closeDetailModal();
            showNotification('ğŸ—‘ï¸ å·²åˆªé™¤');
        }

        // OCR è¾¨è­˜
        async function recognizeCard() {
            if (!currentImage) return;

            const btn = document.getElementById('recognizeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> è¾¨è­˜ä¸­';

            try {
                const base64 = currentImage.split(',')[1];
                const res = await fetch('https://vision.googleapis.com/v1/images:annotate?key=' + CONFIG.VISION_API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests: [{
                            image: { content: base64 },
                            features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
                        }]
                    })
                });

                const data = await res.json();
                console.log('OCR çµæœ:', data);

                if (data.responses && data.responses[0] && data.responses[0].textAnnotations) {
                    const text = data.responses[0].textAnnotations[0].description;
                    document.getElementById('ocrText').textContent = text;
                    document.getElementById('ocrResult').classList.add('active');
                    parseBusinessCard(text);
                    showNotification('âœ… è¾¨è­˜å®Œæˆ');
                } else if (data.error) {
                    showNotification('è¾¨è­˜å¤±æ•—: ' + data.error.message, true);
                } else {
                    showNotification('ç„¡æ³•è¾¨è­˜æ–‡å­—', true);
                }
            } catch (err) {
                console.error('OCR éŒ¯èª¤:', err);
                showNotification('è¾¨è­˜å¤±æ•—: ' + err.message, true);
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ” è¾¨è­˜';
        }

        // è§£æåç‰‡
        function parseBusinessCard(text) {
            const lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });

            // Email
            const emailMatch = text.match(/[\w.-]+@[\w.-]+\.\w+/);
            if (emailMatch) document.getElementById('cardEmail').value = emailMatch[0];

            // é›»è©±
            const phoneMatch = text.match(/09\d{2}[-\s]?\d{3}[-\s]?\d{3}|0\d[-\s]?\d{4}[-\s]?\d{4}|\(\d{2,3}\)[-\s]?\d{3,4}[-\s]?\d{3,4}/);
            if (phoneMatch) document.getElementById('cardPhone').value = phoneMatch[0];

            // å‚³çœŸ
            const faxMatch = text.match(/(?:å‚³çœŸ|FAX|Fax)[:\s]*([0-9\-\s()]+)/i);
            if (faxMatch) document.getElementById('cardFax').value = faxMatch[1].trim();

            // LINE
            const lineMatch = text.match(/(?:LINE|Line|line)[\s:ï¼šID]*([\w._-]+)/i);
            if (lineMatch && lineMatch[1].length > 2) document.getElementById('cardLine').value = lineMatch[1];

            // ç¶²ç«™
            const webMatch = text.match(/(?:www\.[\w.-]+\.\w+)|(?:https?:\/\/[\w.-]+)/i);
            if (webMatch) document.getElementById('cardWebsite').value = webMatch[0];

            // å…¬å¸ - åŠ å¼·ç‰ˆ
            const companyKeywords = ['å…¬å¸', 'ä¼æ¥­', 'æœ‰é™', 'è‚¡ä»½', 'é›†åœ˜', 'å·¥ä½œå®¤', 'äº‹å‹™æ‰€', 'è¨ºæ‰€', 'é†«é™¢', 'éŠ€è¡Œ', 'å­¸é™¢', 'å¤§å­¸', 'å”æœƒ', 'åŸºé‡‘æœƒ', 'å•†è¡Œ', 'å·¥å» ', 'å¯¦æ¥­', 'ç§‘æŠ€', 'é¡§å•', 'Co.', 'Corp', 'Inc', 'Ltd', 'LLC'];
            for (var i = 0; i < lines.length; i++) {
                for (var j = 0; j < companyKeywords.length; j++) {
                    if (lines[i].includes(companyKeywords[j])) {
                        document.getElementById('cardCompany').value = lines[i];
                        break;
                    }
                }
                if (document.getElementById('cardCompany').value) break;
            }

            // è·ç¨±
            const titleKeywords = ['ç¶“ç†', 'ç¸½ç›£', 'ä¸»ç®¡', 'å°ˆå“¡', 'æ¥­å‹™', 'å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'ç¸½è£', 'è‘£äº‹', 'ç¸½ç¶“ç†', 'å‰¯ç¸½', 'å”ç†', 'èª²é•·', 'çµ„é•·', 'æœƒè¨ˆ', 'ç§˜æ›¸', 'åŠ©ç†', 'é¡§å•', 'å¾‹å¸«', 'é†«å¸«', 'æœƒè¨ˆå¸«', 'Director', 'Manager', 'CEO', 'Engineer'];
            for (var i = 0; i < lines.length; i++) {
                if (lines[i] === document.getElementById('cardCompany').value) continue;
                for (var j = 0; j < titleKeywords.length; j++) {
                    if (lines[i].includes(titleKeywords[j])) {
                        document.getElementById('cardTitle').value = lines[i];
                        break;
                    }
                }
                if (document.getElementById('cardTitle').value) break;
            }

            // å§“å
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (line === document.getElementById('cardCompany').value) continue;
                if (line === document.getElementById('cardTitle').value) continue;
                if (line.includes('@') || line.includes('www') || line.match(/\d{4,}/)) continue;
                if (/^[\u4e00-\u9fa5]{2,4}$/.test(line)) {
                    document.getElementById('cardName').value = line;
                    break;
                }
            }

            // åœ°å€
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if ((line.includes('å¸‚') || line.includes('ç¸£')) && (line.includes('å€') || line.includes('è·¯') || line.includes('è¡—'))) {
                    document.getElementById('cardAddress').value = line;
                    break;
                }
            }
        }

        // å·¥å…·
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // éµç›¤
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddModal();
                closeDetailModal();
            }
        });
    </script>
</body>
</html>
